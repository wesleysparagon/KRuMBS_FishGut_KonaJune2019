---
title: "Multivariate Analysis"
author: "Wesley Sparagon"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(vegan)
library(RVAideMemoire)
library(RColorBrewer)
library(viridis)
library(ggplot2)
library(cowplot)
library(lme4)
library(lmerTest)
library(multcomp)
library(lsmeans)
library(pairwiseAdonis)

```

Read in metadata and unifrac data.

```{r}
weighted.unifrac=read.csv(file="weighted.unifrac.csv") #read in weighted unifrac data. This data was generated from CMAIKI nextflow run: "krumbs_konafieldsampling_16s_june_2019_50k_100otu_14042020"

#Process metadata
metadata=read.csv(file="metadata.csv") #read in metadata
metadata$Gut_SubSection1=metadata$Gut_SubSection #create a duplicate gut subsection col
metadata$Gut_SubSection1[metadata$Gut_Zone=="HG"]="HG"
metadata$Gut_SubSection1=factor(metadata$Gut_SubSection1,levels=c("ST","GI_1","GI_2","GI_3","GI_4","HG")) #reorder the levels of the Gut_Subsection factor.
metadata$Gut_Section=factor(metadata$Gut_Section,levels=c("Stomach","Foregut","Midgut","Hindgut","No_Inoc","","GI","Pyloric_caeca")) #reorder the levels of the Gut_Subsection factor.
metadata$Species=factor(metadata$Species,levels=c("Kyphosus cinerascens","Kyphosus hawaiiensis","Kyphosus vaigiensis","")) #reorder the levels of the Species factor.
metadata$Gut_SubSection=factor(metadata$Gut_SubSection,levels=c("ST","GI_1","GI_2","GI_3","GI_4","HG_1","HG_2","HG_3","HG","No_Inoc","","PC","GI")) #reorder the levels of the Gut_SubSection factor.
metadata$Gut_Zone=factor(metadata$Gut_Zone,levels=c("ST","GI","HG","PC","No_Inoc"))
metadata.fish=metadata[metadata$Sample_Type_Broad=="Fish_Gut",] #subset metadata to include only fish gut samples
metadata.fish=metadata.fish[metadata.fish$Gut_Zone!="PC",] #remove all PC samples
metadata.fish.F4.F8=metadata.fish[metadata.fish$Fish_Number!="F1" & metadata.fish$Fish_Number!="F2" & metadata.fish$Fish_Number!="F3",] #subset metadata removing F1-F3, which were sampled differently and are not comprable to fish F4-F8.
metadata.fish.F4.F5.F8=metadata.fish.F4.F8[metadata.fish.F4.F8$Fish_Number!="F6" & metadata.fish.F4.F8$Fish_Number!="F7",] #remove all fish that are not k. vaigiensis, test all models on this subset dataset to see if trends are consistent within one species.

#Read in and work up alpha diversity data.
alpha.diversity=read.csv(file="all_alphaDiversity_100.summary.csv") #read in alpha diversity file
alpha.diversity.fish.F4.F8=alpha.diversity[alpha.diversity$group %in% metadata.fish.F4.F8$SampleCode,] #subset alpha.diversity for only fish gut samples F4-F8.
alpha.diversity.fish.F4.F5.F8=alpha.diversity[alpha.diversity$group %in% metadata.fish.F4.F5.F8$SampleCode,] #subset alpha.diversity for only fish gut samples F4,F5,F8.

#Work up unifrac data.
#To work up the unifrac column data into a matrix, first split the "Groups" column into 2 columns so that each sample name in a pairwise comparison has a seperate column.
unifrac.split.groups=strsplit(as.character(weighted.unifrac$Groups),split="-") #split the groups column by "-", moving the 2 samples that are being compared into seperate vectors within a list.
for (i in 1:nrow(weighted.unifrac)) { #for each row in the unifrac df (corresponding to a pairwise comparison)
  weighted.unifrac$Group1[i]=unifrac.split.groups[[i]][1] #make a new column called Group1, extract the character string from the unifrac.split.groups list that corresponds to the first sample in the pairwise comparison and add it to the Group1 column
  weighted.unifrac$Group2[i]=unifrac.split.groups[[i]][2] #do the same thing but with the second sample in the pairwsie comparison (Group 2)
}
#make an empty df with the number of rows and columns equal to the number of samples you want in the dist matrix. Extract pairwise distances from the unifrac df and move them here.
weighted.unifrac.matrix=as.data.frame(matrix(nrow=length(metadata.fish[,1]),ncol=length(metadata.fish[,1]))) #Use the metadata.fish df to count the number of samples in the weighted.unifrac.matrix
#name the rows and columns according to samples you want in the matrix
rownames(weighted.unifrac.matrix)=metadata.fish$SampleCode
colnames(weighted.unifrac.matrix)=metadata.fish$SampleCode
#for each row (pairwise comparison) in the weighted.unifrac df, extract the W score and then copy it into the correct row and column of the empty weighted.unifrac matrix.
for (i in 1:nrow(weighted.unifrac)) { #for each row in the weighted.unifrac df
    weighted.unifrac.matrix[rownames(weighted.unifrac.matrix)==weighted.unifrac[,4][i], #subset the weigted.unifrac matrix to find the row that corresponds to the target Group1 samplename in the weighted.unifrac df. 
    colnames(weighted.unifrac.matrix)==weighted.unifrac[,5][i]]=weighted.unifrac[,3][i] #subset the weighted.unifrac matrix to find the column that corresponds to the target Group2 samplename in the weighted.unifrac df.
#the weighted.unifrac.matrix has now been subset to the cell that has the row and column values corresponding to the Group1 and Group2 values for the pairwise comparison in the weighted.unifrac df. For this cell, add the corresponding W score for the comparison.
}
#Fill diagnols and finish working up the matrix. 
for (i in 1:nrow(weighted.unifrac.matrix)) { #for each column in the unifrac matrix
    weighted.unifrac.matrix[,i]=t(weighted.unifrac.matrix[i,]) #transpose the values in a given row into it's corresponding column
}
weighted.unifrac.matrix[is.na(weighted.unifrac.matrix)]=0 #replace NAs with 0s
weighted.unifrac.matrix=weighted.unifrac.matrix[as.logical(apply(weighted.unifrac.matrix,1,FUN=sum)),as.logical(apply(weighted.unifrac.matrix,2,FUN=sum))] #subset the weighted.unifrac.matrix so that any rows or columns whose sum=0 are removed. This removes samples which are in the metadata but failed to sequence and/or pass through the pipeline at 50k subsampling.
weighted.unifrac.F4.F8.matrix=weighted.unifrac.matrix[-1:-8,-1:-8] #make a unifrac matrix without the F1-F3 samples. These are excluded do to differences in dissection methodology.
#write.csv(weighted.unifrac.matrix,file="weighted.unifrac.matrix.matrix.csv") #export unifrac matrices as CSVs
weighted.unifrac.F4.F5.F8.matrix=weighted.unifrac.F4.F8.matrix[-17:-29,-17:-29] #make a unifrac matrix with only K. viagiensis samples, to remove the effect of species.
#write.csv(weighted.unifrac.F4.F8.matrix,file="weighted.unifrac.matrix.F4.F8.matrix.csv")
weighted.unifrac.dist=as.dist(weighted.unifrac.matrix) #convert to "dist" type
weighted.unifrac.F4.F8.dist=as.dist(weighted.unifrac.F4.F8.matrix)
weighted.unifrac.F4.F5.F8.dist=as.dist(weighted.unifrac.F4.F5.F8.matrix)
#write.csv(weighted.unifrac.F4.F5.F8.matrix,file="weighted.unifrac.matrix.F4.F5.F8.matrix.csv")

#Make metadata df corresponding to only the samples in the unifrac matrices, eg. only the samples to pass through the sequencing pipeline.
metadata.fish.unifrac=metadata.fish[metadata.fish$SampleCode %in% rownames(weighted.unifrac.matrix),]
metadata.fish.F4.F8.unifrac=metadata.fish.F4.F8[metadata.fish.F4.F8$SampleCode %in% rownames(weighted.unifrac.F4.F8.matrix),]
metadata.fish.F4.F5.F8.unifrac=metadata.fish.F4.F5.F8[metadata.fish.F4.F5.F8$SampleCode %in% rownames(weighted.unifrac.F4.F5.F8.matrix),]

#Export
#write.csv(metadata.fish.unifrac,file="metadata.fish.unifrac.csv") #export updated metadata dfs as CSVs
#write.csv(metadata.fish.F4.F8.unifrac,file="metadata.fish.F4.F8.unifrac.csv")
#write.csv(metadata.fish.F4.F5.F8.unifrac,file="metadata.fish.F4.F5.F8.unifrac.csv")

```

The unifrac data and metadata have been imported and worked up. Next, run PERMANOVAs on the distance matrices.

```{r}
#Model F4-F8 distance matrix without PC samples, predictor variable: Species and Gut_subsection. Use adonis2 marginal tests. 
permanova.gut.subsection=adonis2(weighted.unifrac.F4.F8.dist~Gut_SubSection+Species,by="margin",data=metadata.fish.F4.F8.unifrac,permutations=999)
permanova.gut.subsection

#export for Table X2a
#write.csv(permanova.gut.subsection,file="permanova.gut.subsection.csv")

#Next run pairwise adonis to identify which gut regions differ from each other.
pairwise.gut.subsection1=pairwise.adonis(weighted.unifrac.F4.F8.dist,metadata.fish.F4.F8.unifrac$Gut_SubSection,p.adjust.m = "BH")
pairwise.gut.subsection1

#export pairwsie adonis results as CSV and use for Table SX.
#write.csv(pairwise.gut.subsection1,file="pairwise.gut.subsection1.csv") 
 
```

Next, run a PERMANOVA on the F4.F5.F8 culled data.

```{r}
#Model F4.F5.F8 distance matrix, predictor variable: Gut_subsection. Use adonis2 marginal tests. 
permanova.gut.subsection.v1=adonis2(weighted.unifrac.F4.F5.F8.dist~Gut_SubSection,by="margin",data=metadata.fish.F4.F5.F8.unifrac,permutations=999)
permanova.gut.subsection.v1

#export for Table _____
#write.csv(permanova.gut.subsection.v1,file="permanova.gut.subsection.v1.csv")

#Next run pairwise adonis to identify which gut regions differ from each other.
pairwise.gut.subsection1.v1=pairwise.adonis(weighted.unifrac.F4.F5.F8.dist,metadata.fish.F4.F5.F8.unifrac$Gut_SubSection,p.adjust.m = "BH")
pairwise.gut.subsection1.v1
```


Visualize the PERMANOVA results using NMDS. First, run NMDS.

```{r}
nmds.weighted.unifrac.F4.F8=metaMDS(weighted.unifrac.F4.F8.dist,k=2,trymax=200)
nmds.weighted.unifrac.F4.F8
#two convergent solutions and stress value is acceptable.
```

Plot NMDS.

```{r}
pointvec=c(15,16,17) #generate a vector of points to correspond to Species.
colvec2=c("mediumpurple1",viridis(n=7,option="D",begin=.15)) #generate vector of colors to correspond to Gut_SubSection

#Plot NMDS
plot(nmds.weighted.unifrac.F4.F8,type="n",cex.lab=1.5,cex.axis=1.5) #Set up the NMDS plot environment
points(nmds.weighted.unifrac.F4.F8, #plot each sample as a point
       cex=3.5,
       pch=pointvec[metadata.fish.F4.F8.unifrac$Species], #point shape corresponds to fish Species
       col=colvec2[as.factor(metadata.fish.F4.F8.unifrac$Gut_SubSection)]) 
text(-.465,.4,label="Stress=.14",cex=1.5)
ordiellipse(nmds.weighted.unifrac.F4.F8,metadata.fish.F4.F8.unifrac$Gut_SubSection1,kind="sd",draw="polygon",lwd=2.5,border=colvec2[-6:-7],col=colvec2[-6:-7]) #add SD ellipses, colored by Gut_Section. 
#alpha=c(0,0) used to remove coloration from ellipses
ordiarrows(nmds.weighted.unifrac.F4.F8,group=metadata.fish.F4.F8.unifrac$Fish_Number,order.by=metadata.fish.F4.F8.unifrac$Gut_SubSection,lwd=2,col="black")

#Export as 8.5x9 landscape PDF and use as Figure 2 for manuscript.

```

Work up and visualize the alpha diversity data.

```{r}
#Combine metadata df with respective apha diversity df.
alpha.diversity.fish.F4.F8=cbind(alpha.diversity.fish.F4.F8,metadata.fish.F4.F8.unifrac)
alpha.diversity.fish.F4.F5.F8=cbind(alpha.diversity.fish.F4.F5.F8,metadata.fish.F4.F5.F8.unifrac)

#make a function to calculate standard error
stderror=function(x) {
  se=sd(x)/sqrt(length(x))
  return(se)
}

#First, check to see that the sobs and shannoneven data are normal
hist(alpha.diversity.fish.F4.F8$sobs) #assess normality of sobs data
#shapiro.test(alpha.diversity.fish.F4.F8$sobs)
```

The sobs data look normal.

```{r}
hist(alpha.diversity.fish.F4.F8$shannoneven) #assess normality of shannoneven data
#shapiro.test(alpha.diversity.fish.F4.F8$shannoneven)
```

The shannoneven data look normal.

```{r}
hist(alpha.diversity.fish.F4.F8$shannon) #assess normality of shannoneven data
#shapiro.test(alpha.diversity.fish.F4.F8$shannon)
```

The shannon data looks normal.

Model and plot alpha diversity by Gut_Subsection.

```{r}
#Calculate means and SE of the sobs and shannon evenness alpha diversity metrics for each Gut_SubSection and save as a df. Use for Table X in manuscript
alpha.diversity.mean.gut_subsection=aggregate(alpha.diversity.fish.F4.F8$sobs,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=mean)$x #aggregate (mean) sobs by Gut_SubSection, save in new df.
alpha.diversity.mean.gut_subsection=as.data.frame(alpha.diversity.mean.gut_subsection)
colnames(alpha.diversity.mean.gut_subsection)[1]="sobs" #rename column 1 to sobs.
alpha.diversity.mean.gut_subsection$SE_sobs=aggregate(alpha.diversity.fish.F4.F8$sobs,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=stderror)$x #aggregate (stderror) sobs by Gut_SubSection, save as a new column in df.
#repeat this for shannoneven
alpha.diversity.mean.gut_subsection$shannoneven=aggregate(alpha.diversity.fish.F4.F8$shannoneven,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=mean)$x
alpha.diversity.mean.gut_subsection$SE_shannoneven=aggregate(alpha.diversity.fish.F4.F8$shannoneven,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=stderror)$x
#repeat this for shannon
alpha.diversity.mean.gut_subsection$shannon=aggregate(alpha.diversity.fish.F4.F8$shannon,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=mean)$x
alpha.diversity.mean.gut_subsection$SE_shannon=aggregate(alpha.diversity.fish.F4.F8$shannon,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=stderror)$x
#now add in a Gut_SubSection column
alpha.diversity.mean.gut_subsection$Gut_SubSection=aggregate(alpha.diversity.fish.F4.F8$shannoneven,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=stderror)$Group.1

#Fit a mixed model to the sobs data with Gut_SubSeciton and fish species as fixed effects and fish ID as a random effect.
adiv.mod.gut.subsection.sobs=lmer(sobs~Gut_SubSection+Species+(1|Fish_Number),data=alpha.diversity.fish.F4.F8)
summary(adiv.mod.gut.subsection.sobs)
anova(adiv.mod.gut.subsection.sobs,ddf="Kenward-Roger") #Gut_SubSection is significant, Species is not significant.
lsmeans(adiv.mod.gut.subsection.sobs, pairwise ~ Gut_SubSection, adjust="tukey") #Post Hoc analysis for the Gut_SubSection factor. This function averages across Species so that it is ONLY testing the differences between Gut_SubSection. 

#Repeat for the F4.F5.F8 data.
adiv.mod.gut.subsection.sobs.v1=lmer(sobs~Gut_SubSection+(1|Fish_Number),data=alpha.diversity.fish.F4.F5.F8)
summary(adiv.mod.gut.subsection.sobs.v1)
anova(adiv.mod.gut.subsection.sobs.v1,ddf="Kenward-Roger") #Gut_SubSection is significant, Species is not significant.

#Fit a mixed model to the shannoneven data with Gut_SubSeciton and fish species as fixed effects and fish ID as a random effect.
adiv.mod.gut.subsection.shannoneven=lmer(shannoneven~Gut_SubSection+Species+(1|Fish_Number),data=alpha.diversity.fish.F4.F8)
summary(adiv.mod.gut.subsection.shannoneven)
anova(adiv.mod.gut.subsection.shannoneven,ddf="Kenward-Roger") #Gut_SubSection is significant, species is not.
lsmeans(adiv.mod.gut.subsection.shannoneven, pairwise ~ Gut_SubSection, adjust="tukey")

#Repeat for the F4.F5.F8 data.
adiv.mod.gut.subsection.shannoneven.v1=lmer(shannoneven~Gut_SubSection+(1|Fish_Number),data=alpha.diversity.fish.F4.F5.F8)
summary(adiv.mod.gut.subsection.shannoneven.v1)
anova(adiv.mod.gut.subsection.shannoneven.v1,ddf="Kenward-Roger") #Gut_SubSection is significant, species is not.

#Fit a mixed model to the shannon data with Gut_SubSeciton and fish species as fixed effects and fish ID as a random effect.
adiv.mod.gut.subsection.shannon=lmer(shannon~Gut_SubSection+Species+(1|Fish_Number),data=alpha.diversity.fish.F4.F8)
summary(adiv.mod.gut.subsection.shannon)
anova(adiv.mod.gut.subsection.shannon,ddf="Kenward-Roger") #Gut_SubSection is significant, species is not.
lsmeans(adiv.mod.gut.subsection.shannon, pairwise ~ Gut_SubSection, adjust="tukey")

#Repeat for the F4.F5.F8 data.
adiv.mod.gut.subsection.shannon.v1=lmer(shannon~Gut_SubSection+(1|Fish_Number),data=alpha.diversity.fish.F4.F5.F8)
summary(adiv.mod.gut.subsection.shannon.v1)
anova(adiv.mod.gut.subsection.shannon.v1,ddf="Kenward-Roger") #Gut_SubSection is significant, species is not.

#export this df as a csv for Table X in manuscript.
#write.csv(alpha.diversity.mean.gut_subsection,file="alpha.diversity.mean.gut_subsection.csv")
```

Visualize alpha diversity data.

```{r}
#add in significance indicators to alpha.diversity.fish.F4.F8 for use in boxplots.
#first add significance indicators for sobs.
posthocvec.sobs=c("A","B","B","B","B/C","A/C","A/C","A/C")
alpha.diversity.fish.F4.F8$posthoc.sobs=posthocvec.sobs[alpha.diversity.fish.F4.F8$Gut_SubSection]
#add in significance indicator heights
posthocymax.sobs=aggregate(alpha.diversity.fish.F4.F8$sobs,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=max)[[2]]
alpha.diversity.fish.F4.F8$posthocymax.sobs=posthocymax.sobs[alpha.diversity.fish.F4.F8$Gut_SubSection]
#repeat for shannoneven
posthocvec.shannoneven=c("A","A","A","A/B","A/B","B/C","B/C","B/C")
alpha.diversity.fish.F4.F8$posthoc.shannoneven=posthocvec.shannoneven[alpha.diversity.fish.F4.F8$Gut_SubSection]
#add in significance indicator heights
posthocymax.shannoneven=aggregate(alpha.diversity.fish.F4.F8$shannoneven,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=max)[[2]]
alpha.diversity.fish.F4.F8$posthocymax.shannoneven=posthocymax.shannoneven[alpha.diversity.fish.F4.F8$Gut_SubSection]
#repeat for shannon
posthocvec.shannon=c("A/B","A/B","B","A/B","A/C","C","C","C")
alpha.diversity.fish.F4.F8$posthoc.shannon=posthocvec.shannon[alpha.diversity.fish.F4.F8$Gut_SubSection]
#add in significance indicator heights
posthocymax.shannon=aggregate(alpha.diversity.fish.F4.F8$shannon,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=max)[[2]]
alpha.diversity.fish.F4.F8$posthocymax.shannon=posthocymax.shannon[alpha.diversity.fish.F4.F8$Gut_SubSection]

#Graph sobs and shannoneven indices as a function of Gut_SubSection
sobs.gut.subsection.plot=ggplot(alpha.diversity.fish.F4.F8,aes(x=Gut_SubSection,y=sobs,fill=Gut_SubSection))+
  ylab("Observed ASVs")+
  ylim(75,800)+
  geom_boxplot()+
  scale_fill_manual(values=colvec2)+
  ggtitle("A")+
  theme_classic()+
  theme(legend.position = "none",axis.text=element_text(size=12))+
  geom_text(data=alpha.diversity.fish.F4.F8,aes(x=Gut_SubSection,y=posthocymax.sobs+50,label=posthoc.sobs))

#now repeat for shannoneven
shannoneven.gut.subsection.plot=ggplot(alpha.diversity.fish.F4.F8,aes(x=Gut_SubSection,y=shannoneven,fill=Gut_SubSection))+
  ylab("Shannon evenness")+
  geom_boxplot()+
  scale_fill_manual(values=colvec2)+
  ggtitle("B")+
  theme_classic()+
  theme(legend.position = "none",axis.text=element_text(size=12))+
  geom_text(data=alpha.diversity.fish.F4.F8,aes(x=Gut_SubSection,y=posthocymax.shannoneven+.05,label=posthoc.shannoneven))

#now repeat for shannon
shannon.gut.subsection.plot=ggplot(alpha.diversity.fish.F4.F8,aes(x=Gut_SubSection,y=shannon,fill=Gut_SubSection))+
  ylab("Shannon diversity")+
  geom_boxplot()+
  scale_fill_manual(values=colvec2)+
  ggtitle("C")+
  theme_classic()+
  theme(legend.position = "none",axis.text=element_text(size=12))+
  geom_text(data=alpha.diversity.fish.F4.F8,aes(x=Gut_SubSection,y=posthocymax.shannon+.35,label=posthoc.shannon))

plot_grid(sobs.gut.subsection.plot,shannoneven.gut.subsection.plot,shannon.gut.subsection.plot) ##use the plot_grid function to plot the above 2 plots (par(mfrow=())) doesnt work with ggplot2). Save as PNG (950 x 800) and use as Figure 2 in manuscript.
```

Analyze how the gut microbiome dispersion changes through the gut.

```{r}
#Extract dispersion values from the unifrac data and assess their distribution.
dispersion.gut.subsection=betadisper(weighted.unifrac.F4.F8.dist,type="centroid",group=metadata.fish.F4.F8.unifrac$Gut_SubSection)
dispersion.gut.subsection
dispersion.gut.subsection.F4.F5.F8=betadisper(weighted.unifrac.F4.F5.F8.dist,type="centroid",group=metadata.fish.F4.F5.F8.unifrac$Gut_SubSection) #repeat for F4.F5.F8 data
hist(dispersion.gut.subsection$distances) #asses the distribution of the dispersion data
shapiro.test(dispersion.gut.subsection$distances) #data is not normal and needs to be transformed.
dispersion.gut.subsection$sqrt.distances=sqrt(dispersion.gut.subsection$distances) #square root transform the distance data
dispersion.gut.subsection.F4.F5.F8$sqrt.distances=sqrt(dispersion.gut.subsection.F4.F5.F8$distances) #square root transform the distance data
hist(dispersion.gut.subsection$sqrt.distances) #assess distribution of sqrt transformed dispersion data
shapiro.test(dispersion.gut.subsection$sqrt.distances) #the data appears normal
dispersion.gut.subsection1=as.data.frame(dispersion.gut.subsection[[7]]) #make a new df with just the sqrt distances.
dispersion.gut.subsection1$distances=dispersion.gut.subsection[[3]] #add the original distance values as well.
colnames(dispersion.gut.subsection1)[1]="sqrt.distances"
dispersion.gut.subsection1$samples=rownames(dispersion.gut.subsection1) #add in metadata
dispersion.gut.subsection1$Gut_SubSection=metadata.fish.F4.F8.unifrac$Gut_SubSection
dispersion.gut.subsection1$Gut_Section=metadata.fish.F4.F8.unifrac$Gut_Section
dispersion.gut.subsection1$Species=metadata.fish.F4.F8.unifrac$Species
dispersion.gut.subsection1$Fish_Number=metadata.fish.F4.F8.unifrac$Fish_Number
#repeat df workup for F4.F5.F8 data
dispersion.gut.subsection.F4.F5.F8.1=as.data.frame(dispersion.gut.subsection.F4.F5.F8[[7]]) #make a new df with just the sqrt distances.
dispersion.gut.subsection.F4.F5.F8.1$distances=dispersion.gut.subsection.F4.F5.F8[[3]] #add the original distance values as well.
colnames(dispersion.gut.subsection.F4.F5.F8.1)[1]="sqrt.distances"
dispersion.gut.subsection.F4.F5.F8.1$samples=rownames(dispersion.gut.subsection.F4.F5.F8.1) #add in metadata
dispersion.gut.subsection.F4.F5.F8.1$Gut_SubSection=metadata.fish.F4.F5.F8.unifrac$Gut_SubSection
dispersion.gut.subsection.F4.F5.F8.1$Gut_Section=metadata.fish.F4.F5.F8.unifrac$Gut_Section
dispersion.gut.subsection.F4.F5.F8.1$Species=metadata.fish.F4.F5.F8.unifrac$Species
dispersion.gut.subsection.F4.F5.F8.1$Fish_Number=metadata.fish.F4.F5.F8.unifrac$Fish_Number

#convert dispersion.gut.section1 into df of means and SE so it can be graphed as a barplot. 
dispersion.gut.subsection2=as.data.frame(aggregate(dispersion.gut.subsection1$distances,by=list(dispersion.gut.subsection1$Gut_SubSection),FUN=mean))
dispersion.gut.subsection2$se=aggregate(dispersion.gut.subsection1$distances,by=list(dispersion.gut.subsection1$Gut_SubSection),FUN=stderror)[[2]]
colnames(dispersion.gut.subsection2)=c("Gut_SubSection","distance_to_centroid","se")

#export and use as Table SX1 in manuscript
#write.csv(dispersion.gut.subsection2,file="dispersion.gut.subsection2.csv")

#Fit a mixed model to the sqrt distance values with Gut_SubSection and Species as fixed effects and Fish_Number as a random effect.
dispersion.mod.gut.subsection=lmer(sqrt.distances~Gut_SubSection+Species+(1|Fish_Number),data=dispersion.gut.subsection1)
summary(dispersion.mod.gut.subsection)
anova(dispersion.mod.gut.subsection,ddf="Kenward-Roger") #Gut_SubSectionis significant.
lsmeans(dispersion.mod.gut.subsection, pairwise ~ Gut_SubSection, adjust="tukey")

#Repeat for F4.F5.F8 data
dispersion.mod.gut.subsection.v1=lmer(sqrt.distances~Gut_SubSection+(1|Fish_Number),data=dispersion.gut.subsection.F4.F5.F8.1)
summary(dispersion.mod.gut.subsection.v1)
anova(dispersion.mod.gut.subsection.v1,ddf="Kenward-Roger") #Gut_SubSectionis significant.
```

Visualize dispersion data.

```{r}

dispersion.gut.subsection.plot.v1=ggplot(dispersion.gut.subsection1,aes(y=distances,x=Gut_SubSection,fill=Gut_SubSection))+
  ylab(label="Dispersion (unifrac distance to centroid)")+
  geom_boxplot()+
  scale_fill_manual(values=colvec2)+
  theme_classic()+
  theme(legend.position = "none",axis.text=element_text(size=20),axis.title=element_text(size=20))

dispersion.gut.subsection.plot.v1

#save as 8.5x9 landscape PDF and use as Figure x3

```
