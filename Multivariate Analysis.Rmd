---
title: "Multivariate Analysis"
author: "Wesley Sparagon"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(vegan)
library(RVAideMemoire)
library(RColorBrewer)
library(viridis)
library(ggplot2)
library(cowplot)
library(lme4)
library(lmerTest)
library(multcomp)
library(lsmeans)
library(pairwiseAdonis)

```

Read in metadata and unifrac data.

```{r}
weighted.unifrac=read.csv(file="weighted.unifrac.csv") #read in weighted unifrac data. This data was generated from CMAIKI nextflow run: "krumbs_konafieldsampling_16s_june_2019_50k_100otu_14042020"

metadata=read.csv(file="metadata.csv") #read in metadata
metadata$Gut_Section=factor(metadata$Gut_Section,levels=c("Stomach","Foregut","Midgut","Hindgut","No_Inoc","","GI","Pyloric_caeca")) #reorder the levels of the Gut_Subsection factor. This will be usefu later when generating ordinations.
metadata$Species=factor(metadata$Species,levels=c("Kyphosus cinerascens","Kyphosus hawaiiensis","Kyphosus vaigiensis","")) #reorder the levels of the Species factor. This will be usefu later when generating ordinations.
metadata$Gut_SubSection=factor(metadata$Gut_SubSection,levels=c("ST","GI_1","GI_2","GI_3","GI_4","HG_1","HG_2","HG_3","HG","No_Inoc","","PC","GI")) #reorder the levels of the Gut_SubSection factor. This will be useful later when generating ordinations.
metadata$Gut_Zone=factor(metadata$Gut_Zone,levels=c("ST","GI","HG","PC","No_Inoc"))
metadata.fish=metadata[metadata$Sample_Type_Broad=="Fish_Gut",] #subset metadata to include only fish gut samples
metadata.fish=metadata.fish[metadata.fish$Gut_Zone!="PC",] #remove all PC samples
metadata.fish.F4.F8=metadata.fish[metadata.fish$Fish_Number!="F1" & metadata.fish$Fish_Number!="F2" & metadata.fish$Fish_Number!="F3",] #subset metadata removing F1-F3, which were sampled differently and do not have gut_subsections compared to fish F4-F8.


alpha.diversity=read.csv(file="all_alphaDiversity_100.summary.csv") #read in alpha diversity file
alpha.diversity.fish=alpha.diversity[alpha.diversity$group %in% metadata.fish$SampleCode,] #subset alpha.diversity for only the fish gut samples.
alpha.diversity.fish.F4.F8=alpha.diversity[alpha.diversity$group %in% metadata.fish.F4.F8$SampleCode,] #subset alpha.diversity for only fish gut samples F4-F8.

#To work up the unifrac column data into a matrix, first split the "Groups" column into 2 columns so that each sample name in a pairwise comparison has a seperate column.
unifrac.split.groups=strsplit(as.character(weighted.unifrac$Groups),split="-") #split the groups column by "-", moving the 2 samples that are being compared into seperate vectors within a list.
for (i in 1:nrow(weighted.unifrac)) { #for each row in the unifrac df (corresponding to a pairwise comparison)
  weighted.unifrac$Group1[i]=unifrac.split.groups[[i]][1] #make a new column called Group1, extract the character string from the unifrac.split.groups list that corresponds to the first sample in the pairwise comparison and add it to the Group1 column
  weighted.unifrac$Group2[i]=unifrac.split.groups[[i]][2] #do the same thing but with the second sample in the pairwsie comparison (Group 2)
}
#make an empty df with the number of rows and columns equal to the number of samples you want in the dist matrix. Extract pairwise distances from the unifrac df and move them here.
weighted.unifrac.matrix=as.data.frame(matrix(nrow=length(metadata.fish[,1]),ncol=length(metadata.fish[,1]))) #Use the metadata.fish df to count the number of samples in the weighted.unifrac.matrix
#name the rows and columns according to samples you want in the matrix
rownames(weighted.unifrac.matrix)=metadata.fish$SampleCode
colnames(weighted.unifrac.matrix)=metadata.fish$SampleCode
#for each row (pairwise comparison) in the weighted.unifrac df, extract the W score and then copy it into the correct row and column of the empty weighted.unifrac matrix.
for (i in 1:nrow(weighted.unifrac)) { #for each row in the weighted.unifrac df
    weighted.unifrac.matrix[rownames(weighted.unifrac.matrix)==weighted.unifrac[,4][i], #subset the weigted.unifrac matrix to find the row that corresponds to the target Group1 samplename in the weighted.unifrac df. 
    colnames(weighted.unifrac.matrix)==weighted.unifrac[,5][i]]=weighted.unifrac[,3][i] #subset the weighted.unifrac matrix to find the column that corresponds to the target Group2 samplename in the weighted.unifrac df.
#the weighted.unifrac.matrix has now been subset to the cell that has the row and column values corresponding to the Group1 and Group2 values for the pairwise comparison in the weighted.unifrac df. For this cell, add the corresponding W score for the comparison.
}
#Fill diagnols and finish working up the matrix. 
for (i in 1:nrow(weighted.unifrac.matrix)) { #for each column in the unifrac matrix
    weighted.unifrac.matrix[,i]=t(weighted.unifrac.matrix[i,]) #transpose the values in a given row into it's corresponding column
}
weighted.unifrac.matrix[is.na(weighted.unifrac.matrix)]=0 #replace NAs with 0s
weighted.unifrac.matrix=weighted.unifrac.matrix[as.logical(apply(weighted.unifrac.matrix,1,FUN=sum)),as.logical(apply(weighted.unifrac.matrix,2,FUN=sum))] #subset the weighted.unifrac.matrix so that any rows or columns whose sum=0 are removed. This removes samples which are in the metadata but failed to sequence and/or pass through the pipeline at 50k subsampling.
weighted.unifrac.F4.F8.matrix=weighted.unifrac.matrix[-1:-8,-1:-8] #make a unifrac matrix without the F1-F3 samples. These are excluded do to differences in dissection methodology.
#write.csv(weighted.unifrac.matrix,file="weighted.unifrac.matrix.matrix.csv") #export unifrac matrices as CSVs
#write.csv(weighted.unifrac.F4.F8.matrix,file="weighted.unifrac.matrix.F4.F8.matrix.csv")
weighted.unifrac.dist=as.dist(weighted.unifrac.matrix) #convert to "dist" type
weighted.unifrac.F4.F8.dist=as.dist(weighted.unifrac.F4.F8.matrix)

#Make metadata files corresponding to only the samples in the unifrac matrices, eg. only the samples to pass through the sequencing pipeline.
metadata.fish.unifrac=metadata.fish[metadata.fish$SampleCode %in% rownames(weighted.unifrac.matrix),]
metadata.fish.F4.F8.unifrac=metadata.fish.F4.F8[metadata.fish.F4.F8$SampleCode %in% rownames(weighted.unifrac.F4.F8.matrix),]

#write.csv(metadata.fish.unifrac,file="metadata.fish.unifrac.csv") #export updated metadata dfs as CSVs
#write.csv(metadata.fish.F4.F8.unifrac,file="metadata.fish.F4.F8.unifrac.csv")
```

The unifrac data and metadata have been imported and worked up. Next, run PERMANOVAs on the dist matrices.

```{r}
#First model: full distance matrix (without PC), variables of interest: Species, Gut_section, and Fish_Number as strata.
permanova.gut.zone=adonis.II(weighted.unifrac.dist~Species*Gut_Zone,by="margin",strata=metadata.fish.unifrac$Fish_Number,data=metadata.fish.unifrac,permutations=999)
permanova.gut.zone #Gut_Zone and Species are both significant, no significant interaction.Gut_Zone much more significant

#Check if the strata=metadata.fish$Fish_Number term is influencing the results.
test.no.strata=adonis.II(weighted.unifrac.dist~Species*Gut_Zone,by="margin",data=metadata.fish.unifrac,permutations=999)
test.no.strata #looks like the results are very similar, so the permanova.gut.section model wil be used. Note: Pseudo-F values are exactly the same whereas pvals do change slightly when the strata variable is changed.

#Third model: F4-F8 distance matrix without PC samples, variables of interest: Species, Gut_subsection, and Fish_Number as strata. 
permanova.gut.subsection=adonis(weighted.unifrac.F4.F8.dist~Gut_SubSection*Species,by="margin",strata=metadata.fish.F4.F8.unifrac$Fish_Number,data=metadata.fish.F4.F8.unifrac,permutations=999)
permanova.gut.subsection #Gut_SubSection and Species are both significant and have similar F values. Non significant significant interaction.

#write.csv(permanova.gut.subsection$aov.tab,file="permanova.gut.subsection.csv") #export permanova results and save as CSV to be used for Table X2 in manuscript.

#Next run pairwise adonis and the 3rd model to identify which gut regions differ from each other.
pairwise.gut.zone=pairwise.adonis(weighted.unifrac.dist,metadata.fish.unifrac$Gut_Zone)
pairwise.gut.zone

pairwise.gut.subsection=pairwise.adonis(weighted.unifrac.F4.F8.dist,metadata.fish.F4.F8.unifrac$Gut_SubSection)
pairwise.gut.subsection

pairwise.gut.subsection1=pairwise.adonis(weighted.unifrac.F4.F8.dist,metadata.fish.F4.F8.unifrac$Gut_SubSection,p.adjust.m = "BH")
pairwise.gut.subsection1

#write.csv(pairwise.gut.subsection1,file="pairwise.gut.subsection1.csv") 
#export pairwsie adonis results as CSV and use for Table SX in manuscript. 

pairwise.species=pairwise.adonis(weighted.unifrac.F4.F8.dist,metadata.fish.F4.F8.unifrac$Species)
pairwise.species

mean(pairwise.species$R2)

mean(pairwise.gut.subsection$R2)

#The mean R2 value for pairwise gut subsection comparisons is nearly triple that of pairise species comparisons.
```

Both Gut Section/SubSection and Species have a significant effect on fish gut microbiome community structure, with no significant interaction, although there is a marinally significant interaction (p<.01) in the gut_subsection model. When Species and Gut_Section are the predictors, Gut_Section has a stronger effect on the fish gut microbiome then species. When Species and Gut_SubSection are the predictors, they have similar strength effects on the fish gut microbiome. adonis.II does not produce R2 values, but if adonis ir run, the R2 value for gut subsection is much higher (~.5) than the R2 alues for Species (~.15). Pairwise comparisons reveal that all Gut Sections are significantly different from each other (after padjustment) and that no gut subsections are significantly different from each other (after p adjustment). Craig and I have discussed lumping gut samples into gut sections based on the pairwise permanova results (see Figure SX). Further models will then nest "gut subsection" within "gut section." One other issue that needs to be dealt with is the justification of the treatment of species. Given that our explicit goal was not to test microbiome differences across species, as well as the fact that we have a very low sample size for certain species which makes it hard to fit a good model, I suggest we do not include species in subsequent models and address it at the end/in a supplement. However, in the gut subsection permanova species and subsection have similar p and F values (both significant), making it hard to justify dropping the term. Best approach would be to use the R2 values from a regular adonis (NOT adonis.II) and/or pairwise.adonis to suggest that Species epxlains much less variation and justify it's removal.

Visualize the PERMANOVA results using NMDS. First, run NMDS.

```{r}
nmds.weighted.unifrac=metaMDS(weighted.unifrac.dist,k=2,trymax=200)
nmds.weighted.unifrac 
#convergent solution reached and stress value is acceptable.

nmds.weighted.unifrac.F4.F8=metaMDS(weighted.unifrac.F4.F8.dist,k=2,trymax=200)
nmds.weighted.unifrac.F4.F8
#two convergent solutions and stress value is acceptable.
```

NMDS results seem fine, so make ordinations of the NMDS results.

```{r}
pointvec=c(15,16,17) #generate a vector of points to correspond to Species.
colvec=c("mediumpurple1",viridis(n=3,option="D")[2:3]) #generate a vector of colors to correspond to Gut_Zone.

plot(nmds.weighted.unifrac,type="n") #Set up the NMDS plot environment
points(nmds.weighted.unifrac, #plot each sample as a point
       cex=2,
       pch=pointvec[metadata.fish.unifrac$Species], #point shape corresponds to fish Species
       col=colvec[metadata.fish.unifrac$Gut_Zone]) #point color corresponds to Gut_Zone
ordiellipse(nmds.weighted.unifrac,metadata.fish.unifrac$Gut_Zone,kind="sd",draw="polygon",alpha=c(0,0),lwd=2.5,border=colvec) #add SD ellipses, colored by Gut_Zone
legend(.2,-.22,legend = c("Stomach","Fore/midgut","Hindgut","K. cinerascens","K. hawaiiensis","K. vaigiensis"),cex=1,y.intersp=.25,bg="transparent",bty="o",col=c(colvec,"black","black","black"),pch=c(16,16,16,15,16,17),pt.cex=2) #Add legend. Save image as 8.5x11 PDF (landscape)


```

The gut zoness all form relativley distinct clusters.

Next, plot the same NMDS but color by Gut_SubSection instead of Gut_Zone. Do this using the subset unifrac matrix and metadata that only contain F4-F8. Plot a NMDS in base R colored by Gut_SubSection but with ellipses by Gut_Section

```{r}
colvec2=c("mediumpurple1",viridis(n=7,option="D",begin=.15))

plot(nmds.weighted.unifrac.F4.F8,type="n") #Set up the NMDS plot environment
points(nmds.weighted.unifrac.F4.F8, #plot each sample as a point
       cex=3.5,
       pch=pointvec[metadata.fish.F4.F8.unifrac$Species], #point shape corresponds to fish Species
       col=colvec2[as.factor(metadata.fish.F4.F8.unifrac$Gut_SubSection)]) 
text(-.475,.4,label="Stress=.14")
ordiellipse(nmds.weighted.unifrac.F4.F8,metadata.fish.F4.F8.unifrac$Gut_Zone,kind="sd",draw="polygon",alpha=c(0,0),lwd=2.5,border=c("mediumpurple1",viridis(n=3,option="D")[2:3])) #add SD ellipses, colored by Gut_Section.
ordiarrows(nmds.weighted.unifrac.F4.F8,group=metadata.fish.F4.F8.unifrac$Fish_Number,order.by=metadata.fish.F4.F8.unifrac$Gut_SubSection,lwd=2,col="black")

#Export as 8.5x9 PDF. merge with a legend, dispersion graph, and corresponding NMDS and dispersion graphs for metabolomics data and use that as Figure X3 for manuscript.

#Additional options with arrows include
#plot(nmds.weighted.unifrac.F4.F8,type="n") #Set up the NMDS plot environment
#points(nmds.weighted.unifrac.F4.F8, #plot each sample as a point
      #cex=4,
       #pch=pointvec[metadata.fish.F4.F8.unifrac$Species], #point shape corresponds to fish Species
       #col=colvec2[as.factor(metadata.fish.F4.F8.unifrac$Gut_SubSection)]) 
#text(-.5,.275,label="Stress=.14")
#ordiellipse(nmds.weighted.unifrac.F4.F8,metadata.fish.F4.F8.unifrac$Gut_Zone,kind="sd",draw="polygon",alpha=c(0,0),lwd=2.5,border=c("mediumpurple1",viridis(n=3,option="D")[2:3])) #add SD ellipses, colored by Gut_Section.
#ordiarrows(nmds.weighted.unifrac.F4.F8,group=metadata.fish.F4.F8.unifrac$Fish_Number,order.by=metadata.fish.F4.F8.unifrac$Gut_SubSection,lwd=2,col="black")

```


Next, draw arrows from ST->HG for individual fish to further visualize this successional gradient. NOTE this might be removed since arrows may go in Fig 3

```{r}
#colvec2=viridis(n=8,option="D")
#plot(nmds.weighted.unifrac.F4.F8,type="n") #Set up the NMDS plot environment
#points(nmds.weighted.unifrac.F4.F8, #plot each sample as a point
       #cex=2,
       #pch=pointvec[metadata.fish.F4.F8.unifrac$Species], #point shape corresponds to fish Species
       #col=colvec2[as.factor(metadata.fish.F4.F8.unifrac$Gut_SubSection)]) 
#ordiarrows(nmds.weighted.unifrac.F4.F8,group=metadata.fish.F4.F8.unifrac$Fish_Number,order.by=metadata.fish.F4.F8.unifrac$Gut_SubSection,show.groups=c("F4","F7","F8"),lwd=2,col="black")

#Export as 8.5x11 landscape PDF, merge with legend PNG to generate Figure SX2 for manuscript.
```

These arrows track changes in 3 individual fishes' (F4, F7, F8) gut microbiomes. Each arrow connects the ordinated gut microbial communities in the correct order (St->HG_3). This further elucidates the consisten microbial community gradient we see through the fish gut.

Next, work up and visualize the alpha diversity data to see if there are any trends.

```{r}
#Combine metadata df with respective apha diversity df.
alpha.diversity.fish=cbind(alpha.diversity.fish,metadata.fish.unifrac)
alpha.diversity.fish.F4.F8=cbind(alpha.diversity.fish.F4.F8,metadata.fish.F4.F8.unifrac)

#make a function to calculate standard error
stderror=function(x) {
  se=sd(x)/sqrt(length(x))
  return(se)
}

#Calculate means and SE of the sobs and shannon evenness alpha diversity metrics for each Gut_Section and save as a df. This code will not be used in the final manuscript.
#alpha.diversity.mean.gut_Zone=aggregate(alpha.diversity.fish$sobs,by=list(alpha.diversity.fish$Gut_Zone),FUN=mean)$x #aggregate (mean) sobs by Gut_Section, save in new df.
#alpha.diversity.mean.gut_Zone=as.data.frame(alpha.diversity.mean.gut_Zone)
#colnames(alpha.diversity.mean.gut_Zone)[1]="sobs" #rename column 1 to sobs.
#alpha.diversity.mean.gut_Zone$SE_sobs=aggregate(alpha.diversity.fish$sobs,by=list(alpha.diversity.fish$Gut_Zone),FUN=stderror)$x #aggregate (stderror) sobs by Gut_Zone, save as a new column in df.
#repeat this for shannoneven
#alpha.diversity.mean.gut_Zone$shannoneven=aggregate(alpha.diversity.fish$shannoneven,by=list(alpha.diversity.fish$Gut_Zone),FUN=mean)$x
#alpha.diversity.mean.gut_Zone$SE_shannoneven=aggregate(alpha.diversity.fish$shannoneven,by=list(alpha.diversity.fish$Gut_Zone),FUN=stderror)$x
#now add in a Gut_Zone column
#alpha.diversity.mean.gut_Zone$Gut_Zone=aggregate(alpha.diversity.fish$shannoneven,by=list(alpha.diversity.fish$Gut_Zone),FUN=stderror)$Group.1

#Model the alpha diversity (sobs and shannoneven and shannon) metrics using mixed models with Gut_Section and Fish_Species as fixed effects and Fish_ID as a random effect.
#First, check to see that the sobs and shannoneven data are normal
hist(alpha.diversity.fish.F4.F8$sobs) #asses normality of sobs data
```

The sobs data look normal.

```{r}
hist(alpha.diversity.fish.F4.F8$shannoneven) #asses normality of shannoneven data

```

The shannoneven data look normal.

```{r}
hist(alpha.diversity.fish.F4.F8$shannon) #asses normality of shannoneven data

```

The shannon data looks normal, although not great...

```{r}
#use the GI culled data! Do not include this section in final analysis
#Model the sobs data in response to Gut_seciton, fish species, and fish ID
#adiv.mod.gut.nested.sobs=lmer(sobs~Gut_Zone/Gut_SubSection+Species+(1|Fish_Number),data=alpha.diversity.fish)
#summary(adiv.mod.gut.nested.sobs) #Note that including the Fish_Number ranef yields a singularity error regardless of species
#anova(adiv.mod.gut.nested.sobs,ddf="Kenward-Roger") #Gut_Section is significant
#lsmeans(adiv.mod.gut.nested.sobs, pairwise ~ Gut_Zone, adjust="tukey") #HG and ST are not significantly different from each other, both are significantly different from GI.

#Model the shannoneven data in response to Gut_seciton, fish species, and fish ID
#adiv.mod.gut.Zone.shannoneven=lmer(shannoneven~Gut_Zone+Species+(1|Fish_Number),data=alpha.diversity.fish)
#summary(adiv.mod.gut.Zone.shannoneven)
#anova(adiv.mod.gut.Zone.shannoneven,ddf="Kenward-Roger") #Gut_Zone is significant
#lsmeans(adiv.mod.gut.Zone.shannoneven, pairwise ~ Gut_Zone, adjust="tukey")
#HG is significantly different from ST and GI. ST and GI are not significantly different from each other.
```

For both sobs and shannoneven, Gut Section was a significant predictor while Species was not. Species will therefore be left out of the visualizations.

```{r}
#Graph alpha diversity indices as a function of Gut_Section
sobs.gut.section.plot=ggplot(alpha.diversity.mean.gut_Zone,aes(x=Gut_Zone,y=sobs,fill=Gut_Zone))+
  ylim(0,675)+
  geom_bar(stat="identity")+
  scale_fill_manual(values=colvec)+
  geom_errorbar(aes(ymin=sobs-SE_sobs,ymax=sobs+SE_sobs),width=.5)+
  ggtitle("Observed Sequences")+
  theme_classic()+
  theme(legend.position = "none")+
  geom_text(x=1:3,y=c(650,275,550),label=c("A","B","A"))

#now repeat for shannoneven
shannoneven.gut.Zone.plot=ggplot(alpha.diversity.mean.gut_Zone,aes(x=Gut_Zone,y=shannoneven,fill=Gut_Zone))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=colvec)+
  geom_errorbar(aes(ymin=shannoneven-SE_shannoneven,ymax=shannoneven+SE_shannoneven),width=.5)+
  ggtitle("Shannon Eveness")+
  theme_classic()+
  theme(legend.position = "none")+
  geom_text(x=1:3,y=c(.625,.625,.84),label=c("A","A","B"))+
  ylim(0,.85)

#plot_grid(sobs.gut.section.plot,shannoneven.gut.section.plot) #use the plot_grid function to plot the above 4 plots (par(mfrow=())) doesnt work with ggplot2. Export as PNG (800 x 455).  this is now producing an error saying aesthetics must be either length 1 or the same as the data (5). Since I am not using these graphs I am not going to deal with it right now.
```


Sobs shows both ST and HG to have substantially higher alpha diversity compared to GI. Shannon eveness shows HG to have substantially higher alpha diversity than all other gut sections.

Next, model and plot the same alpha diversity metrics by Gut_SUBsection.

```{r}
#Calculate means and SE of the sobs and shannon evenness alpha diversity metrics for each Gut_SubSection and save as a df
alpha.diversity.mean.gut_subsection=aggregate(alpha.diversity.fish.F4.F8$sobs,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=mean)$x #aggregate (mean) sobs by Gut_SubSection, save in new df.
alpha.diversity.mean.gut_subsection=as.data.frame(alpha.diversity.mean.gut_subsection)
colnames(alpha.diversity.mean.gut_subsection)[1]="sobs" #rename column 1 to sobs.
alpha.diversity.mean.gut_subsection$SE_sobs=aggregate(alpha.diversity.fish.F4.F8$sobs,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=stderror)$x #aggregate (stderror) sobs by Gut_SubSection, save as a new column in df.
#repeat this for shannoneven
alpha.diversity.mean.gut_subsection$shannoneven=aggregate(alpha.diversity.fish.F4.F8$shannoneven,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=mean)$x
alpha.diversity.mean.gut_subsection$SE_shannoneven=aggregate(alpha.diversity.fish.F4.F8$shannoneven,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=stderror)$x
#now add in a Gut_SubSection column
alpha.diversity.mean.gut_subsection$Gut_SubSection=aggregate(alpha.diversity.fish.F4.F8$shannoneven,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=stderror)$Group.1
#repeat this for shannon
alpha.diversity.mean.gut_subsection$shannon=aggregate(alpha.diversity.fish.F4.F8$shannon,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=mean)$x
alpha.diversity.mean.gut_subsection$SE_shannon=aggregate(alpha.diversity.fish.F4.F8$shannon,by=list(alpha.diversity.fish.F4.F8$Gut_SubSection),FUN=stderror)$x

#Model the sobs data in response to Gut_SubSeciton, fish species, and fish ID
adiv.mod.gut.subsection.sobs=lmer(sobs~Gut_SubSection+Species+(1|Fish_Number),data=alpha.diversity.fish.F4.F8) #interaction term has been removed to prevent errors.
summary(adiv.mod.gut.subsection.sobs)
anova(adiv.mod.gut.subsection.sobs,ddf="Kenward-Roger") #Gut_SubSection is significant, Species is not significant.
lsmeans(adiv.mod.gut.subsection.sobs, pairwise ~ Gut_SubSection, adjust="tukey") #Post Hoc analysis for the Gut_SubSection factor. This function averages across Species so that it is ONLY testing the differences between Gut_SubSection. 

#Model the shannoneven data in response to Gut_subseciton, fish species, and fish ID
adiv.mod.gut.subsection.shannoneven=lmer(shannoneven~Gut_SubSection+Species+(1|Fish_Number),data=alpha.diversity.fish.F4.F8)
summary(adiv.mod.gut.subsection.shannoneven)
anova(adiv.mod.gut.subsection.shannoneven,ddf="Kenward-Roger") #Gut_SubSection is significant, species is not.
lsmeans(adiv.mod.gut.subsection.shannoneven, pairwise ~ Gut_SubSection, adjust="tukey")

#model the shannon data in response to Gut_subsection, fish species, and fish ID
adiv.mod.gut.subsection.shannon=lmer(shannon~Gut_SubSection+Species+(1|Fish_Number),data=alpha.diversity.fish.F4.F8)
summary(adiv.mod.gut.subsection.shannon)
anova(adiv.mod.gut.subsection.shannon,ddf="Kenward-Roger") #Gut_SubSection is significant, species is not.
lsmeans(adiv.mod.gut.subsection.shannon, pairwise ~ Gut_SubSection, adjust="tukey")

#write.csv(alpha.diversity.mean.gut_subsection,file="alpha.diversity.mean.gut_subsection.csv") export this df as a csv for Table X in manuscript.
```

Gut_SubSection is a significant predictor of both sobs and shannoneven. The modes appear to struggle with certain Species:Gut_SubSection terms, likely because of limited sample size for certain species making it impossible to asses certain interactions. After removing the interactions, the models appear to perform fine.

```{r}
#Graph sobs and shannoneven indices as a function of Gut_SubSection
sobs.gut.subsection.plot=ggplot(alpha.diversity.mean.gut_subsection,aes(x=Gut_SubSection,y=sobs,fill=Gut_SubSection))+
  ylab("Observed ASVs")+
  ylim(0,680)+
  geom_bar(stat="identity")+
  scale_fill_manual(values=colvec2)+
  geom_errorbar(aes(ymin=sobs-SE_sobs,ymax=sobs+SE_sobs),width=.5)+
  ggtitle("A")+
  theme_classic()+
  theme(legend.position = "none",axis.text=element_text(size=12))+
  geom_text(x=1:8,y=c(675,275,240,275,440,625,595,570),aes(label=c("A","B","B","B","B/C","A/C","A/C","A/C")))

#now repeat for shannoneven
shannoneven.gut.subsection.plot=ggplot(alpha.diversity.mean.gut_subsection,aes(x=Gut_SubSection,y=shannoneven,fill=Gut_SubSection))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=colvec2)+
  geom_errorbar(aes(ymin=shannoneven-SE_shannoneven,ymax=shannoneven+SE_shannoneven),width=.5)+
  ggtitle("B")+
  theme_classic()+
  ylim(0,.87)+
  theme(legend.position = "none",axis.text=element_text(size=12))+
  geom_text(x=1:8,y=c(.6,.6,.6,.75,.75,.85,.85,.85),aes(label=c("A","A","A","A/B","A/B","B","B","B")))

shannon.gut.subsection.plot=ggplot(alpha.diversity.mean.gut_subsection,aes(x=Gut_SubSection,y=shannon,fill=Gut_SubSection))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=colvec2)+
  geom_errorbar(aes(ymin=shannon-SE_shannon,ymax=shannon+SE_shannon),width=.5)+
  ggtitle("C")+
  theme_classic()+
  ylim(0,5.3)+
  theme(legend.position = "none",axis.text=element_text(size=12))+
  geom_text(x=1:8,y=c(4,3.25,3.25,4,4.3,5.3,5.3,5.3),aes(label=c("A/B","A/B","B","A/B","A/C","C","C","C")))

plot_grid(sobs.gut.subsection.plot,shannoneven.gut.subsection.plot,shannon.gut.subsection.plot) ##use the plot_grid function to plot the above 2 plots (par(mfrow=())) doesnt work with ggplot2. Save as PNG (995 x 750) and use as Figure 1 in manuscript.
```


Overall, similar patterns in the gut subsections as in the gut sections. Sobs high in the ST and HG, lowest in the early GI and increasing as you progress to the hindgut. Shannon evenness progresses from lowest to highest as you transect through the gut from ST to HG_3.

Next, look at how the gut microbiome dispersion changes through the gut.

```{r}
#Extract dispersion values from the unifrac data and asses their distribution.
dispersion.gut.subsection=betadisper(weighted.unifrac.F4.F8.dist,type="centroid",group=metadata.fish.F4.F8.unifrac$Gut_SubSection)
dispersion.gut.subsection
hist(dispersion.gut.subsection$distances) #asses the distribution of the dispersion data
shapiro.test(dispersion.gut.subsection$distances) #data is not normal and needs to be transformed.
dispersion.gut.subsection$sqrt.distances=sqrt(dispersion.gut.subsection$distances) #square root transform the distance data
hist(dispersion.gut.subsection$sqrt.distances) #asses distribution of sqrt transformed dispersion data
shapiro.test(dispersion.gut.subsection$sqrt.distances) #the data appears (barely) normal
dispersion.gut.subsection1=as.data.frame(dispersion.gut.subsection[[7]]) #make a new df with just the sqrt distances.
dispersion.gut.subsection1$distances=dispersion.gut.subsection[[3]] #add the original distance values as well.
colnames(dispersion.gut.subsection1)[1]="sqrt.distances"
dispersion.gut.subsection1$samples=rownames(dispersion.gut.subsection1) #add in metadata
dispersion.gut.subsection1$Gut_SubSection=metadata.fish.F4.F8.unifrac$Gut_SubSection
dispersion.gut.subsection1$Gut_Section=metadata.fish.F4.F8.unifrac$Gut_Section
dispersion.gut.subsection1$Species=metadata.fish.F4.F8.unifrac$Species
dispersion.gut.subsection1$Fish_Number=metadata.fish.F4.F8.unifrac$Fish_Number

#convert dispersion.gut.section1 into df of means and SE so it can be graphed as a barplot.
dispersion.gut.subsection2=as.data.frame(aggregate(dispersion.gut.subsection1$distances,by=list(dispersion.gut.subsection1$Gut_SubSection),FUN=mean))
dispersion.gut.subsection2$se=aggregate(dispersion.gut.subsection1$distances,by=list(dispersion.gut.subsection1$Gut_SubSection),FUN=stderror)[[2]]
colnames(dispersion.gut.subsection2)=c("Gut_SubSection","distance_to_centroid","se")

#Model the sqrt distance values in response to Gut_SubSection and Fish_Number as a random effect.
dispersion.mod.gut.subsection=lmer(sqrt.distances~Gut_SubSection+Species+(1|Fish_Number),data=dispersion.gut.subsection1)
summary(dispersion.mod.gut.subsection)
anova(dispersion.mod.gut.subsection,ddf="Kenward-Roger") #Gut_SubSectionis significant.
lsmeans(dispersion.mod.gut.subsection, pairwise ~ Gut_SubSection, adjust="tukey")
```

UPDATE THIS SECTION!!!
There is a significant difference in distances to centroid for the various gut sections and fish species, as well as their interaction. However, both models have "rank defficient" warnings which may be indicative of the limited sample size for certain Species-Gut_SubSection interactions. I need to look into this more. I am uncertain if interaction terms should be included in these models.

```{r}

dispersion.gut.subsection.plot.v1=ggplot(dispersion.gut.subsection1,aes(y=distances,x=Gut_SubSection,fill=Gut_SubSection))+
  ylab(label="unifrac distance to centroid")+
  geom_boxplot()+
  scale_fill_manual(values=colvec2)+
  theme_classic()+
  theme(legend.position = "none")

dispersion.gut.subsection.plot.v1

#save as 8.5x9 and use as Figure x3

```

Generally, HG(1-3) samples had the lowest dispersion while all the GI samples (1-4) had the highest. ST samples had low dispersion, close to that of the HG samples. There was substantial variation between species, with k. cinerascens and k. hawaiiensis having high dispersions than k. vaigiensis. In all species HG smaples had relativley low dispersion while GI samples had relativley high dispersion. In K. vaigiensis, ST dispersion was high (equal to that of GI) whereas in the other 2 species ST dispersion was much lower.