---
title: "ASV Analysis"
author: "Wesley Sparagon"
date: "4/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Read in and work up data/metadata.

```{r}
library(phyloseq)
library(lme4)
library(lmerTest)
library(multcomp)
library(ggplot2)
library(cowplot)
library(gridExtra)

#set up custom functions
cull.otu=function(relabund.df, min.num, min.abund, min.single.abund) {
  #Inputs:  relabund.df = dataframe containing ONLY relative abundance data, no metadata or other info. Samples in rows and OTUs in columns.
            
            #min.num = the minimum number of samples an OTU needs to be present in to not be culled.
            
            #min.abund = the minimum relative abundance an OTU needs to have in (the min.num) samples to not be culled.
 
            #min.single.abund = the minimum relative abundance an OTU needs to have in a SINGLE sample to not be culled.
   
  sub=c() #create a empty vector
  
  cull=function(x) { #make a function that says for any input, generate a logical vector of TRUEs and FALSEs that will be used for subsetting, selecting OTUs that
    sub=ifelse(length(x[x>=min.abund])>=min.num #have a relabund>"min.abund" in "min.num" samples 
               | length(x[x>=min.single.abund])>0,TRUE,FALSE) #or have a relabund>"min.single.abund" in at least one sample
    return(sub)
  }
  
  cull.vec=apply(relabund.df,2,FUN=cull) #apply cull function to relabund.df, save output as a vector.
  relabund.df.cull=relabund.df[,cull.vec] #Use cull.vec to subset the columns of relabund.df for OTUs that passed the cull threshold.
  
  relabund.df.cull<<-relabund.df.cull
}

#Read in metadata
metadata=read.csv(file="metadata.csv")
metadata.fish.noPC.unifrac=read.csv(file="metadata.fish.noPC.unifrac.csv")
metadata.fish.F4.F8.noPC.unifrac=read.csv(file="metadata.fish.F4.F8.noPC.unifrac.csv")
metadata.fish.F4.F8.noPC.unifrac$Gut_SubSection=factor(metadata.fish.F4.F8.noPC.unifrac$Gut_SubSection,levels=c("GI_1","GI_2","GI_3","GI_4","HG_1","HG_2","HG_3","ST","PC")) #reorder the levels of the Gut_SubSection factor. This will be useful later when making plots.
metadata.fish.noPC.noST.unifrac=metadata.fish.noPC.unifrac[metadata.fish.noPC.unifrac$Gut_Section!="ST",] #remove ST samples
metadata.fish.F4.F8.noPC.noST.unifrac=metadata.fish.F4.F8.noPC.unifrac[metadata.fish.F4.F8.noPC.unifrac$Gut_SubSection!="ST",] #remove ST samples

relabund=read.csv(file="abundance_table_100.csv") #read in relative abundance table
rownames(relabund)=relabund$OTUNumber #make rownames correspond to OTU names
relabund=relabund[,-1] #remove column 1 (OTU name column)
relabund.t=relabund[,-87:-95]  #remove last 9 columns (which correspond to character vectors, taxonomy, etc.). Save as a new df which will be transposed. Must remove columns 87:89 BEFORE transposing.
relabund.t=as.data.frame(t(relabund.t)) #transpose relabund.t df

abund=read.csv(file="abundance_table_100.shared.csv") #read in abundance table
rownames(abund)=abund$Group #make rownames correspond to OTU names
abund=abund[,-1:-3] #remove columns 1-3 (non OTU columns)

#subset relabund, relabund.t, and abund so they match with respective metadata
relabund.fish=relabund[,colnames(relabund) %in% metadata.fish.noPC.noST.unifrac$SampleCode]
relabund.fish.F4.F8=relabund.fish[,colnames(relabund.fish) %in% metadata.fish.F4.F8.noPC.noST.unifrac$SampleCode]
relabund.fish=cbind(relabund.fish,relabund[,87:95]) #add back in taxonomy info
relabund.fish.F4.F8=cbind(relabund.fish.F4.F8,relabund[,87:95]) #add back in taxonomy info
relabund.t.fish=relabund.t[rownames(relabund.t) %in% metadata.fish.noPC.noST.unifrac$SampleCode,]
relabund.t.fish.F4.F8=relabund.t.fish[rownames(relabund.t.fish) %in% metadata.fish.F4.F8.noPC.noST.unifrac$SampleCode,]
abund.fish=abund[rownames(abund) %in% metadata.fish.noPC.noST.unifrac$SampleCode,]
abund.fish.F4.F8=abund.fish[rownames(abund.fish) %in% metadata.fish.F4.F8.noPC.noST.unifrac$SampleCode,]

taxonomy.fish=relabund.fish[,42:48] #make a taxonomy df for fish ASVs
```

Cull low abundance ASVs.

```{r}
#First visualize the distribution of relabund values.
mean.relabund.t=apply(relabund.t,2,FUN=mean) #calculate the mean relabund value for each ASV.
hist(mean.relabund.t,breaks=seq(0,.08,by=.0001),xlim=c(0,.02)) #make a histogram ranging from 0 - .02, with break every .0001 intervals. 
```

It looks like the most frequent relative abundance is very low. Preliminary relabund cull at .0001?

```{r}
#Cull ASVs at .0005 relabund cutoff (in at least 3 samples) or .01 relabund in 1 sample.
cull.otu(relabund.t.fish,3,.0005,.01)
relabund.t.fish.cull=relabund.df.cull #rename output
cull.otu(relabund.t.fish.F4.F8,3,.0005,.01) #repeat for the relabund.t.fish.F4.F8 df
relabund.t.fish.F4.F8.cull=relabund.df.cull #rename output
relabund.fish.cull=as.data.frame(t(relabund.t.fish.cull)) #transpose culled relabund data
relabund.fish.F4.F8.cull=as.data.frame(t(relabund.t.fish.F4.F8.cull)) #transpose culled relabund data

#export relabund dfs as CSVs
write.csv(relabund.fish.cull,file="relabund.fish.cull.csv")
write.csv(relabund.fish.F4.F8.cull,file="relabund.fish.F4.F8.cull.csv")

#make a taxonomy df for culled fish ASVs
taxonomy.fish.cull=taxonomy.fish[rownames(taxonomy.fish) %in% rownames(relabund.fish.cull),]
taxonomy.fish.F4.F8.cull=taxonomy.fish[rownames(taxonomy.fish) %in% rownames(relabund.fish.F4.F8.cull),]
colnames(taxonomy.fish.cull)[2]="Kingdom" #change name of column 1 to Kingdom. This is necessary for phyloseq.
colnames(taxonomy.fish.F4.F8.cull)[2]="Kingdom" #change name of column 1 to Kingdom. This is necessary for phyloseq.
taxonomy.fish.cull=taxonomy.fish.cull[,-1] #remove first column. This is necessary for phyloseq.
taxonomy.fish.F4.F8.cull=taxonomy.fish.F4.F8.cull[,-1] #remove first column. This is necessary for phyloseq.
```


To visualize broad trends between gut subsections, we need to look at a higher taxonomic rank than ASVs. To do this, use phyloseq to glom ASVs by various taxonomic ranks and then export the data out of phyloseq.

```{r}
#Convert relabund data, taxonomy data, and metadata to phyloseq objects and merge them. Use the F4.F8 PC and ST culled data.
otu.phyloseq=otu_table(relabund.t.fish.F4.F8.cull,taxa_are_rows=FALSE) 
taxonomy.phyloseq=tax_table(as.matrix(taxonomy.fish.F4.F8.cull))
rownames(metadata.fish.F4.F8.noPC.noST.unifrac)=metadata.fish.F4.F8.noPC.noST.unifrac$SampleCode #need to make rownames correspond to sample names for phyloseq
metadata.phyloseq=sample_data(metadata.fish.F4.F8.noPC.noST.unifrac)
fish.cull.phyloseq=phyloseq(otu.phyloseq,taxonomy.phyloseq,metadata.phyloseq)

#Use tax_glom() to glom relative abundance values by specific taxonomic ranks
relabund.cull.phylum=tax_glom(fish.cull.phyloseq,taxrank="Phylum")
relabund.cull.class=tax_glom(fish.cull.phyloseq,taxrank="Class")
relabund.cull.order=tax_glom(fish.cull.phyloseq,taxrank="Order")
relabund.cull.family=tax_glom(fish.cull.phyloseq,taxrank="Family")
relabund.cull.genus=tax_glom(fish.cull.phyloseq,taxrank="Genus")

#Use psmelt() to convert these from phyloseq class objects to normals dfs.
relabund.cull.phylum.df=psmelt(relabund.cull.phylum)
relabund.cull.class.df=psmelt(relabund.cull.class)
relabund.cull.order.df=psmelt(relabund.cull.order)
relabund.cull.family.df=psmelt(relabund.cull.family)
relabund.cull.genus.df=psmelt(relabund.cull.genus)

write.csv(relabund.cull.family.df,file="relabund.cull.family.df.csv") #Export the ralbund.cull.genus (or family) data as a CSV and open it in JMP. Use JMP to create stacked bar charts.
```

Now model how individual ASVs respond to gut subsection and species and then use these results to pick specific ASVs for visualization.

```{r}
#Work up the relative abundance data for analysis.
relabund.t.fish.F4.F8.cull.trans=asin(sqrt(relabund.t.fish.F4.F8.cull)) #arcsine sqrt transform relative abundance data to normalize. Save as new df.
relabund.t.fish.F4.F8.cull.trans=cbind(relabund.t.fish.F4.F8.cull.trans,metadata.fish.F4.F8.noPC.noST.unifrac) #merge metadata into relabund data

#now run a mixed model on the transformed ASV data. Have relative abundance be a function of Species, Gut_SubSection, and Fish_Number be a random effect. Interaction term has been removed since it was not significant in the multivariate analysis. Could re-run model with Species also as a random effect.
mixed.mod=function(x) { #create a function that performs the desired mixed model
  mod=lmer(x~Species+Gut_SubSection+(1|Fish_Number),data=relabund.t.fish.F4.F8.cull.trans)
  return(mod)
}
mixed.mod.relabund.t.fish.F4.F8.cull.trans=apply(relabund.t.fish.F4.F8.cull.trans[,-693:-702],2,FUN=mixed.mod) #apply mixed.mod only to columns containing ASV data. Save as new object.

#Now let's inspect the results of the mixed models.
mixed.mod.singularity=lapply(mixed.mod.relabund.t.fish.F4.F8.cull.trans,FUN=isSingular) #test each mixed model for singularity, save in list. After inspecting the list it looks like most models are not singular.
anova.kw=function(x) { #make a function that performs anova (Kenward-Roger)
  results=anova(x,ddf="Kenward-Roger")
  return(results)
}
mixed.mod.results=lapply(mixed.mod.relabund.t.fish.F4.F8.cull.trans,FUN=anova.kw) #perform an anova(ddf="Kenward-Roger") on all mixed models, save output.
mixed.mod.pvals=as.data.frame(t(as.data.frame(mixed.mod.results))[seq(from=6,to=4152,by=6),]) #extract the pvas from the mixed.mod.results list. Do this by converting list to df, transposing it, and then extracting every 6th column (which correspond to the pvals from each model).

#Work up p values
mixed.mod.pvals$Gut_SubSection.padjust=p.adjust(mixed.mod.pvals$Gut_SubSection,method="BH") #Adjust p values for multiple comparisons
mixed.mod.pvals$Species.padjust=p.adjust(mixed.mod.pvals$Species,method="BH") #Adjust p values for multiple comparisons
rownames(mixed.mod.pvals)=colnames(relabund.t.fish.F4.F8.cull.trans)[1:692] #Change rownames to correspond with tested OTU names.
mixed.mod.sig.otu.Gut_SubSection=mixed.mod.pvals[mixed.mod.pvals$Gut_SubSection.padjust<=.05,] #subset the mixed.mod.pvals df for significant (p<=.05) Gut_SubSection pvals. Save as new df.
mixed.mod.sig.otu.Gut_SubSection=cbind(mixed.mod.sig.otu.Gut_SubSection,taxonomy.fish.F4.F8.cull[rownames(taxonomy.fish.F4.F8.cull) %in% rownames(mixed.mod.sig.otu.Gut_SubSection),],relabund.fish.F4.F8.cull[rownames(relabund.fish.F4.F8.cull) %in% rownames(mixed.mod.sig.otu.Gut_SubSection),]) #merge mixed.mod.sig.otu.Gut_SubSection with the associated OTU taxonomies.
mixed.mod.sig.otu.Species=mixed.mod.pvals[mixed.mod.pvals$Species.padjust<=.05,] #subset the mixed.mod.pvals df for significant (p<=.05) Gut_SubSection pvals. Save as new df. It appears there are no significant Species pvals after padjustment. Will need to look into why this is. Perhaps if using the full sample set that includes F1-F3 GI/HG samples there would be enough replication to find significant species pvals.
#create an output zscore df and calculate z score for each otu using the scale function.
mixed.mod.sig.otu.Gut_SubSection_zscore=as.data.frame(t(mixed.mod.sig.otu.Gut_SubSection[,-1:-10]))

for (i in 1:ncol(mixed.mod.sig.otu.Gut_SubSection_zscore)) { #calculate the zscore
  mixed.mod.sig.otu.Gut_SubSection_zscore[,i]=scale(mixed.mod.sig.otu.Gut_SubSection_zscore[,i],center=TRUE,scale=TRUE)
}

#export new dfs
write.csv(mixed.mod.sig.otu.Gut_SubSection_zscore,file="mixed.mod.sig.otu.Gut_SubSection_zscore.csv")
write.csv(mixed.mod.sig.otu.Gut_SubSection,file="mixed.mod.sig.otu.Gut_SubSection.csv")

```

Check to see if various culling thresholds of the significant ASVs produce a better number of sig ASVs for visualization.

```{r}
#subset the relabund.t.fish.F4.F8.cull df to select only the significant ASVs (by gut subsection).
relabund.t.fish.F4.F8.cull.sig.subsection=relabund.t.fish.F4.F8.cull[,colnames(relabund.t.fish.F4.F8.cull) %in% rownames(mixed.mod.sig.otu.Gut_SubSection)]

cull.otu(relabund.t.fish.F4.F8.cull.sig.subsection,1,.01,.01)
relabund.t.fish.F4.F8.cull.sig.subsection.cull=relabund.df.cull
ncol(relabund.t.fish.F4.F8.cull.sig.subsection.cull) #59 significant ASVs remain after culling at the threshold: .01 relabund (1%) in at least 1 sample.
relabund.t.fish.F4.F8.cull.sig.subsection.cull=cbind(relabund.t.fish.F4.F8.cull.sig.subsection.cull,metadata.fish.F4.F8.noPC.noST.unifrac) #add in metadata

#subset the mixed.mod.sig.otu.Gut_SubSection df for only these 59 ASvs.
mixed.mod.sig.otu.Gut_SubSection.cull=mixed.mod.sig.otu.Gut_SubSection[rownames(mixed.mod.sig.otu.Gut_SubSection) %in% colnames(relabund.t.fish.F4.F8.cull.sig.subsection.cull),]

#Updated colnames
colnames(relabund.t.fish.F4.F8.cull.sig.subsection.cull)[1:59]=paste(mixed.mod.sig.otu.Gut_SubSection.cull$Genus,rownames(mixed.mod.sig.otu.Gut_SubSection.cull),sep="_") #change colnames to correspond to ASV Family_ASVnumber

#subset the mixed.mod.sig.otu.Gut_SubSection_zscore df to select only the culled significant ASVs.
mixed.mod.sig.otu.Gut_SubSection_zscore.cull=mixed.mod.sig.otu.Gut_SubSection_zscore[,colnames(mixed.mod.sig.otu.Gut_SubSection_zscore) %in% rownames(mixed.mod.sig.otu.Gut_SubSection.cull)]

write.csv(mixed.mod.sig.otu.Gut_SubSection_zscore.cull,file="mixed.mod.sig.otu.Gut_SubSection_zscore.cull.csv")
write.csv(relabund.t.fish.F4.F8.cull.sig.subsection.cull,file="relabund.t.fish.F4.F8.cull.sig.subsection.cull.csv")
write.csv(mixed.mod.sig.otu.Gut_SubSection.cull,file="mixed.mod.sig.otu.Gut_SubSection.cull.csv")
```

Exported mixed.mod.sig.otu.Gut_Subsection inspected in excel for promising ASVs. In the exported "mixed.mod.sig.otu.Gut_SubSection.csv" file in excel, calculate the mean relabund for each significant ASV in each gut section and add them as new columns. Reformat the file as "long format", so that there is ONE column for Gut_SubSection, with the mean relabund for each ASV represented for each Gut_SubSection (so each ASV is repeated 7 times). Now I will visualize the changes in relabund of these ASVs across the gut.

```{r}
mixed.mod.sig.otu.Gut_SubSection.longformat=read.csv(file="mixed.mod.sig.otu.Gut_SubSection_longformat.csv") #read in the long format file
mixed.mod.sig.otu.Gut_SubSection.longformat.cull=mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$OTU %in% rownames(mixed.mod.sig.otu.Gut_SubSection.cull),] #subset the longformat df to select only the culled significant ASVs.

#visualize these culled significant ASVs. Group (using facet_wrap) by family, color code by genus, and use black ines to divide different ASVs. Export as a 2000x1997 PNG.
ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat.cull,aes(x=Gut_SubSection,y=mean_relabund,fill=Genus))+
    geom_bar(stat="identity",col="black")+
    facet_wrap(~Family,scales="free")+
  theme(legend.position="bottom")

#graph the relative abundance of significant ASVs across the gut subsections as stacked barcharts. Graph within family,fill by family ID but keep individual ASVs seperated by black lines. Lable ASV# on each portion of the barchart, with the size of the label proportional to the relabund of that ASV in that sample.
proteo.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Proteobacteria",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Proteobacteria",]$mean_relabund))*15,position = position_stack(vjust = 0.5))+
  ggtitle(label="Proteobacteria") 

unclassified.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Bacteria_unclassified",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Bacteria_unclassified",]$mean_relabund))*30,position = position_stack(vjust = 0.5))+
  ggtitle(label="Unclassified_Phylum") #save as landscape PDF

bacteroidetes.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Bacteroidetes",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Bacteroidetes",]$mean_relabund))*25,position = position_stack(vjust = 0.5))+
  ggtitle(label="Bacteroidetes") #save as landscape PDF

tenericutes.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Tenericutes",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Tenericutes",]$mean_relabund))*25,position = position_stack(vjust = 0.5))+
  ggtitle(label="Tenericutes") #save as landscape PDF

actino.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Actinobacteria",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Actinobacteria",]$mean_relabund))*80,position = position_stack(vjust = 0.5))+
  ggtitle(label="Actinobacteria") #save as landscape PDF

firmicutes.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Firmicutes",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Firmicutes",]$mean_relabund))*15,position = position_stack(vjust = 0.5))+
  ggtitle(label="Firmicutes")

cyano.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Cyanobacteria",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Cyanobacteria",]$mean_relabund))*75,position = position_stack(vjust = 0.5))+
  ggtitle(label="Cyanobacteria")

lentis.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Lentisphaerae",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Lentisphaerae",]$mean_relabund))*50,position = position_stack(vjust = 0.5))+
  ggtitle(label="Lentisphaerae")

parabasalia.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Parabasalia",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Parabasalia",]$mean_relabund))*40,position = position_stack(vjust = 0.5))+
  ggtitle(label="Parabasalia")

spirochaetes.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Spirochaetes",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Spirochaetes",]$mean_relabund))*40,position = position_stack(vjust = 0.5))+
  ggtitle(label="Spirochaetes")

synergist.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Synergistetes",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Synergistetes",]$mean_relabund))*200,position = position_stack(vjust = 0.5))+
  ggtitle(label="Synergistetes")

verruco.sig.otus=ggplot(mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Verrucomicrobia",],aes(x=Gut_SubSection,y=mean_relabund,fill=Family))+
  geom_bar(stat="identity",col="black")+
  geom_text(aes(label=OTU),size=sqrt((mixed.mod.sig.otu.Gut_SubSection.longformat[mixed.mod.sig.otu.Gut_SubSection.longformat$Phylum=="Verrucomicrobia",]$mean_relabund))*30,position = position_stack(vjust = 0.5))+
  ggtitle(label="Verrucomicrobia")

```

