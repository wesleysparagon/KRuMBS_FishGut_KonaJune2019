---
title: "Multivariate Analysis"
author: "Wesley Sparagon"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(vegan)
library(RVAideMemoire)
library(RColorBrewer)
library(viridis)
library(ggplot2)
library(cowplot)
library(lme4)
library(lmerTest)
library(multcomp)
```

Read in metadata and unifrac data.

```{r}
weighted.unifrac=read.csv(file="weighted.unifrac.csv") #read in weighted unifrac data. This data was generated from CMAIKI nextflow run: "krumbs_konafieldsampling_16s_june_2019_50k_100otu_14042020"

metadata=read.csv(file="metadata.csv") #read in metadata
metadata$Gut_Section=factor(metadata$Gut_Section,levels=c("ST","PC","GI","HG","No_Inoc","")) #reorder the levels of the Gut_Subsection factor. This will be usefu later when generating ordinations.
metadata$Species=factor(metadata$Species,levels=c("Kyphosus cinerascens","Kyphosus hawaiiensis","Kyphosus vaigiensis","")) #reorder the levels of the Species factor. This will be usefu later when generating ordinations.
metadata$Gut_SubSection=factor(metadata$Gut_SubSection,levels=c("ST","PC","GI","GI_1","GI_2","GI_3","GI_4","HG","HG_1","HG_2","HG_3","No_Inoc","")) #reorder the levels of the Gut_SubSection factor. This will be useful later when generating ordinations.
metadata.fish=metadata[metadata$Sample_Type_Broad=="Fish_Gut",] #subset metadata to include only fish gut samples
metadata.fish.F4.F8=metadata.fish[metadata.fish$Gut_SubSection!="GI" & metadata.fish$Gut_SubSection!="HG",] #subset metadata removing Gut_SubSections GI and HG. This corresponds to the HG/GI samples from F1-F3, which were sampled differently and do not have gut_subsections compared to fish F4-F8.
metadata.fish.2=metadata.fish[metadata.fish$Gut_SubSection!="PC",] #remove all PC samples
metadata.fish.F4.F8.2=metadata.fish.F4.F8[metadata.fish.F4.F8$Gut_SubSection!="PC",] #remove all PC samples
metadata.fish.2$Gut_Section=factor(metadata.fish.2$Gut_Section,levels=c("ST","GI","HG","No_Inoc","","PC")) #reorder the levels of the Gut_section factor. This will be useful later when generating ordinations.
metadata.fish.F4.F8.2$Gut_SubSection=factor(metadata.fish.F4.F8.2$Gut_SubSection,levels=c("ST","GI_1","GI_2","GI_3","GI_4","HG_1","HG_2","HG_3","No_Inoc","","PC","GI","HG"))
#reorder the levels of the Gut_Subsection factor. This will be useful later when generating ordinations.

alpha.diversity=read.csv(file="all_alphaDiversity_100.summary.csv") #read in alpha diversity file
alpha.diversity.fish=alpha.diversity[alpha.diversity$group %in% metadata.fish$SampleCode,] #subset alpha.diversity for only the fish gut samples.
alpha.diversity.fish.F4.F8=alpha.diversity[alpha.diversity$group %in% metadata.fish.F4.F8$SampleCode,] #subset alpha.diversity for only fish gut samples F4-F8.
alpha.diversity.fish.2=alpha.diversity.fish[alpha.diversity.fish$group %in% metadata.fish.2$SampleCode,] #remove PC samples
alpha.diversity.fish.F4.F8.2=alpha.diversity.fish[alpha.diversity.fish$group %in% metadata.fish.F4.F8.2$SampleCode,] #remove PC samples

#To work up the unifrac column data into a matrix, first split the "Groups" column into 2 columns so that each sample name in a pairwise comparison has a seperate column.
unifrac.split.groups=strsplit(as.character(weighted.unifrac$Groups),split="-") #split the groups column by "-", moving the 2 samples that are being compared into seperate vectors within a list.
for (i in 1:nrow(weighted.unifrac)) { #for each row in the unifrac df (corresponding to a pairwise comparison)
  weighted.unifrac$Group1[i]=unifrac.split.groups[[i]][1] #make a new column called Group1, extract the character string from the unifrac.split.groups list that corresponds to the first sample in the pairwise comparison and add it to the Group1 column
  weighted.unifrac$Group2[i]=unifrac.split.groups[[i]][2] #do the same thing but with the second sample in the pairwsie comparison (Group 2)
}
#make an empty df with the number of rows and columns equal to the number of samples you want in the dist matrix. Extract pairwise distances from the unifrac df and move them here.
weighted.unifrac.matrix=as.data.frame(matrix(nrow=length(metadata.fish[,1]),ncol=length(metadata.fish[,1]))) #Use the metadata.fish df to count the number of samples in the weighted.unifrac.matrix
#name the rows and columns according to samples you want in the matrix
rownames(weighted.unifrac.matrix)=metadata.fish$SampleCode
colnames(weighted.unifrac.matrix)=metadata.fish$SampleCode
#for each row (pairwise comparison) in the weighted.unifrac df, extract the W score and then copy it into the correct row and column of the empty weighted.unifrac matrix.
for (i in 1:nrow(weighted.unifrac)) { #for each row in the weighted.unifrac df
    weighted.unifrac.matrix[rownames(weighted.unifrac.matrix)==weighted.unifrac[,4][i], #subset the weigted.unifrac matrix to find the row that corresponds to the target Group1 samplename in the weighted.unifrac df. 
    colnames(weighted.unifrac.matrix)==weighted.unifrac[,5][i]]=weighted.unifrac[,3][i] #subset the weighted.unifrac matrix to find the column that corresponds to the target Group2 samplename in the weighted.unifrac df.
#the weighted.unifrac.matrix has now been subset to the cell that has the row and column values corresponding to the Group1 and Group2 values for the pairwise comparison in the weighted.unifrac df. For this cell, add the corresponding W score for the comparison.
}
#Fill diagnols and finish working up the matrix. 
for (i in 1:nrow(weighted.unifrac.matrix)) { #for each column in the unifrac matrix
    weighted.unifrac.matrix[,i]=t(weighted.unifrac.matrix[i,]) #transpose the values in a given row into it's corresponding column
}
weighted.unifrac.matrix[is.na(weighted.unifrac.matrix)]=0 #replace NAs with 0s
weighted.unifrac.matrix=weighted.unifrac.matrix[as.logical(apply(weighted.unifrac.matrix,1,FUN=sum)),as.logical(apply(weighted.unifrac.matrix,2,FUN=sum))] #subset the weighted.unifrac.matrix so that any rows or columns whose sum=0 are removed. This removes samples which are in the metadata but failed to sequence and/or pass through the pipeline at 50k subsampling.
weighted.unifrac.2.matrix=weighted.unifrac.matrix[c(-3,-7,-10,-19,-28,-36),c(-3,-7,-10,-19,-28,-36)] #remove the PC samples
weighted.unifrac.F4.F8.matrix=weighted.unifrac.matrix[c(-1:-2,-5:-6,-8:-9),c(-1:-2,-5:-6,-8:-9)] #make a unifrac matrix without the F1-F3 GI and HG samples.. These are excluded do to differences in dissection methodology.
weighted.unifrac.F4.F8.2.matrix=weighted.unifrac.F4.F8.matrix[c(-1,-3,-4,-13,-22,-30),c(-1,-3,-4,-13,-22,-30)] #remove PC samples
write.csv(weighted.unifrac.matrix,file="weighted.unifrac.matrix.matrix.csv") #export unifrac matrices as CSVs
write.csv(weighted.unifrac.F4.F8.matrix,file="weighted.unifrac.matrix.F4.F8.matrix.csv")
weighted.unifrac.dist=as.dist(weighted.unifrac.matrix) #convert to "dist" type
weighted.unifrac.F4.F8.dist=as.dist(weighted.unifrac.F4.F8.matrix)
weighted.unifrac.2.dist=as.dist(weighted.unifrac.2.matrix)
weighted.unifrac.F4.F8.2.dist=as.dist(weighted.unifrac.F4.F8.2.matrix)

#Make metadata files corresponding to only the samples in the unifrac matrices, eg. only the samples to pass through the sequencing pipeline.
metadata.fish.1=metadata.fish[metadata.fish$SampleCode %in% rownames(weighted.unifrac.matrix),]
metadata.fish.F4.F8.1=metadata.fish.F4.F8[metadata.fish.F4.F8$SampleCode %in% rownames(weighted.unifrac.F4.F8.matrix),]
metadata.fish.2.unifrac=metadata.fish.2[metadata.fish.2$SampleCode %in% rownames(weighted.unifrac.2.matrix),]
metadata.fish.F4.F8.2.unifrac=metadata.fish.F4.F8.2[metadata.fish.F4.F8.2$SampleCode %in% rownames(weighted.unifrac.F4.F8.2.matrix),]

write.csv(metadata.fish.1,file="metadata.fish.1.csv") #export updated metadata dfs as CSVs
write.csv(metadata.fish.F4.F8.1,file="metadata.fish.F4.F8.1.csv")
```

The unifrac data and metadata have been imported and worked up. Next, run PERMANOVAs on the dist matrices.

```{r}
#First model: full distance matrix, variables of interest: Species, Gut_section, and Fish_Number as strata.
permanova.gut.section=adonis.II(weighted.unifrac.dist~Species*Gut_Section,by="margin",strata=metadata.fish.1$Fish_Number,data=metadata.fish.1,permutations=999)
permanova.gut.section #Gut_Subsection and Species are both significant, no significant interaction.

#Check if the strata=metadata.fish$Fish_Number term is influencing the results.
test.no.strata=permanova.gut.section=adonis.II(weighted.unifrac.dist~Species*Gut_Section,by="margin",data=metadata.fish.1,permutations=999)
test.no.strata #looks like the results are very similar, so the permanova.gut.section model wil be used. Note: Pseudo-F values are exactly the same whereas pvals do change slightly when the strata variable is changed.

#Second model: F4-F8 distance matrix, variables of interest. Species, Gut_subsection, and Fish_Number as strata. Note: because F1-F3 were sampled differently (no gut_subsections), they are removed from this model.
permanova.gut.subsection=adonis.II(weighted.unifrac.F4.F8.dist~Species*Gut_SubSection,by="margin",strata=metadata.fish.F4.F8.1$Fish_Number,data=metadata.fish.F4.F8.1,permutations=999)
permanova.gut.subsection #Gut_SubSection and Species are both significant. No significant interaction.

#Third (revised) model: distance matrix without PC, variables of interest: Species, Gut_section, and Fish_Number as strata.
permanova.gut.section.2=adonis.II(weighted.unifrac.2.dist~Species*Gut_Section,by="margin",strata=metadata.fish.2.unifrac$Fish_Number,data=metadata.fish.2.unifrac,permutations=999)
permanova.gut.section.2 #Gut_Section and Species are significant. No significant interaction.

#Fourth (revised) model: F4-F8 distance matrix without PC samples, variables of interest: Species, Gut_subsection, and Fish_Number as strata. 
permanova.gut.subsection.2=adonis.II(weighted.unifrac.F4.F8.2.dist~Species*Gut_SubSection,by="margin",strata=metadata.fish.F4.F8.2.unifrac$Fish_Number,data=metadata.fish.F4.F8.2.unifrac,permutations=999)
permanova.gut.subsection.2 #Gut_SubSection and Species are both significant. Marginally significant interaction.


#NEED TO RUN PAIRSWISE ADONIS ON EVERYTHING

```

Both Gut Section/SubSection and Species have a significant effect on fish gut microbiome community structure, with no significant interaction, although there is a marinally significant interaction (p<.01) in the gut_subsection model. When Species and Gut_Section are the predictors, Gut_Section has a stronger effect on the fish gut microbiome then species. When Species and Gut_SubSection are the predictors, they have similar strength effects on the fish gut microbiome (Species has a slightly higher F value).

Visualize the PERMANOVA results using NMDS. First, run NMDS.

```{r}
nmds.weighted.unifrac=metaMDS(weighted.unifrac.dist,k=2,trymax=200)
nmds.weighted.unifrac 
#no convergent solution but stress value is acceptable.

nmds.weighted.unifrac.F4.F8=metaMDS(weighted.unifrac.F4.F8.dist,k=2,trymax=200)
nmds.weighted.unifrac.F4.F8
#no convergent solution but stress value is acceptable.

nmds.weighted.unifrac.2=metaMDS(weighted.unifrac.2.dist,k=2,trymax=200)
nmds.weighted.unifrac.2
#convergent solution and stress value is acceptable

nmds.weighted.unifrac.F4.F8.2=metaMDS(weighted.unifrac.F4.F8.2.dist,k=2,trymax=200)
nmds.weighted.unifrac.F4.F8.2
#convergent solution and stress value is acceptable
```

NMDS results seem fine, so make ordinations of the NMDS results.

```{r}
pointvec=c(15,16,17) #generate a vector of points to correspond to Species.
colvec=viridis(n=3,option="D") #generate a vector of colors to correspond to Gut_Section.

plot(nmds.weighted.unifrac,type="n",xlim=c(-.5,.5)) #Set up the NMDS plot environment
points(nmds.weighted.unifrac, #plot each sample as a point
       cex=2,
       pch=pointvec[metadata.fish.1$Species], #point shape corresponds to fish Species
       col=colvec[metadata.fish.1$Gut_Section]) #point color corresponds to Gut_Section
ordiellipse(nmds.weighted.unifrac,metadata.fish.1$Gut_Section,kind="sd",draw="polygon",alpha=c(0,0),lwd=2.5,border=colvec) #add SD ellipses, colored by Gut_Section
legend(.2,.42,legend = c(levels(as.factor(metadata.fish.1$Gut_Section))[1:4],"K. cinerascens","K. hawaiiensis","K. vaigiensis"),cex=1,y.intersp=.2,bg="transparent",bty="o",col=c(colvec,"black","black","black"),pch=c(16,16,16,16,15,16,17),pt.cex=1.5) #Add legend. Save image as 8.5x11 PDF (landscape)

#Next make the same plot with the updated dist matrices
plot(nmds.weighted.unifrac.2,type="n") #Set up the NMDS plot environment
points(nmds.weighted.unifrac.2, #plot each sample as a point
       cex=2,
       pch=pointvec[metadata.fish.2.unifrac$Species], #point shape corresponds to fish Species
       col=colvec[metadata.fish.2.unifrac$Gut_Section]) #point color corresponds to Gut_Section
ordiellipse(nmds.weighted.unifrac.2,metadata.fish.2.unifrac$Gut_Section,kind="sd",draw="polygon",alpha=c(0,0),lwd=2.5,border=colvec) #add SD ellipses, colored by Gut_Section
legend(.2,-.22,legend = c("Stomach","Fore/midgut","Hindgut","K. cinerascens","K. hawaiiensis","K. vaigiensis"),cex=1,y.intersp=.25,bg="transparent",bty="o",col=c(colvec,"black","black","black"),pch=c(16,16,16,15,16,17),pt.cex=2) #Add legend. Save image as 8.5x11 PDF (landscape)


```

Next, plot the same NMDS but color by Gut_SubSection instead of Gut_Section. Do this using the subset unifrac matrix and metadata that only contain F4-F8.

```{r}
#This graph will be made in ggplot2 since it can perform color gradients well.
nmds.scores=as.data.frame(scores(nmds.weighted.unifrac.F4.F8)) #extract NMDS scores and save in new df
nmds.scores$Gut_SubSection=metadata.fish.F4.F8.1$Gut_SubSection #add the Fish_GutSubsection to the new df
nmds.scores$Ranked_Distance_from_Stomach=metadata.fish.F4.F8.1$Ranked_Gut_SubSection_Distance_from_Stomach #Add Ranked_Gut_SubSection_Distance_from_Stomach to df, give it a shorter name
nmds.scores$Species=metadata.fish.F4.F8.1$Species #Add Species to the new df.
nmds.scores$Fish_Number=metadata.fish.F4.F8.1$Fish_Number

#repeat for the PC culled nmds
nmds.scores.2=as.data.frame(scores(nmds.weighted.unifrac.F4.F8.2)) #extract NMDS scores and save in new df
nmds.scores.2$Gut_SubSection=metadata.fish.F4.F8.2.unifrac$Gut_SubSection #add the Fish_GutSubsection to the new df
nmds.scores.2$Ranked_Distance_from_Stomach=metadata.fish.F4.F8.2.unifrac$Ranked_Gut_SubSection_Distance_from_Stomach #Add Ranked_Gut_SubSection_Distance_from_Stomach to df, give it a shorter name
nmds.scores.2$Species=metadata.fish.F4.F8.2.unifrac$Species #Add Species to the new df.
nmds.scores.2$Fish_Number=metadata.fish.F4.F8.2.unifrac$Fish_Number

ggplot(nmds.scores.2,aes(x=NMDS1,y=NMDS2,shape=Species,color=Gut_SubSection,size=2))+ #plot nmds.scores, specify x and y axis, shape corresponding to species, color corresponding to Ranked_Distance_from_Stomach
  scale_color_manual(values=viridis(n=8,option="D"))+ #set gradient scale to desired viridis scale
  geom_point(data=nmds.scores.2,aes(x=NMDS1,y=NMDS2))+ #add points
  theme_classic() #export graphs as 8.5x11 PDF (landscape)

#next, draw arrows from ST->HG for one fish
colvec2=viridis(n=8,option="D")
plot(nmds.weighted.unifrac.F4.F8.2,type="n",xlim=c(-.5,.53),ylim=c(-.4,.4)) #Set up the NMDS plot environment
points(nmds.weighted.unifrac.F4.F8.2, #plot each sample as a point
       cex=2,
       pch=pointvec[metadata.fish.F4.F8.2.unifrac$Species], #point shape corresponds to fish Species
       col=colvec2[as.factor(metadata.fish.F4.F8.2.unifrac$Gut_SubSection)]) 
ordiarrows(nmds.weighted.unifrac.F4.F8.2,group=metadata.fish.F4.F8.2.unifrac$Fish_Number,order.by=metadata.fish.F4.F8.2.unifrac$Gut_SubSection,show.groups=c("F4","F7","F8"),lwd=2,col="black")

legend(.3,.45,legend = c("ST","GI_1","GI_2","GI_3","GI_4","HG_1","HG_2","HG_3","K. cinerascens","K. hawaiiensis","K. vaigiensis"),cex=1,y.intersp=.2,bg="transparent",bty="o",col=c(colvec2,"black","black","black"),pch=c(16,16,16,16,16,16,16,16,15,16,17),pt.cex=1.5) #Add legend. Save image as 8.5x11 PDF (landscape)

```

Next, work up and visualize the alpha diversity data to see if there are any trends.

```{r}
#Combine metadata df with respective apha diversity df.
alpha.diversity.fish=cbind(alpha.diversity.fish,metadata.fish.1)
alpha.diversity.fish.F4.F8=cbind(alpha.diversity.fish.F4.F8,metadata.fish.F4.F8.1)
alpha.diversity.fish.2=cbind(alpha.diversity.fish.2,metadata.fish.2.unifrac)
alpha.diversity.fish.F4.F8.2=cbind(alpha.diversity.fish.F4.F8.2,metadata.fish.F4.F8.2.unifrac)

#make a function to calculate standard error
stderror=function(x) {
  se=sd(x)/sqrt(length(x))
  return(se)
}

#Calculate means and SE of the sobs and shannon evenness alpha diversity metrics for each Gut_Section and save as a df
alpha.diversity.2.mean.gut_section=aggregate(alpha.diversity.fish.2$sobs,by=list(alpha.diversity.fish.2$Gut_Section),FUN=mean)$x #aggregate (mean) sobs by Gut_Section, save in new df.
alpha.diversity.2.mean.gut_section=as.data.frame(alpha.diversity.2.mean.gut_section)
colnames(alpha.diversity.2.mean.gut_section)[1]="sobs" #rename column 1 to sobs.
alpha.diversity.2.mean.gut_section$SE_sobs=aggregate(alpha.diversity.fish.2$sobs,by=list(alpha.diversity.fish.2$Gut_Section),FUN=stderror)$x #aggregate (stderror) sobs by Gut_section, save as a new column in df.
#repeat this for shannoneven
alpha.diversity.2.mean.gut_section$shannoneven=aggregate(alpha.diversity.fish.2$shannoneven,by=list(alpha.diversity.fish.2$Gut_Section),FUN=mean)$x
alpha.diversity.2.mean.gut_section$SE_shannoneven=aggregate(alpha.diversity.fish.2$shannoneven,by=list(alpha.diversity.fish.2$Gut_Section),FUN=stderror)$x
#now add in a Gut_Section column
alpha.diversity.2.mean.gut_section$Gut_Section=aggregate(alpha.diversity.fish.2$shannoneven,by=list(alpha.diversity.fish.2$Gut_Section),FUN=stderror)$Group.1

#Model the alpha diversity (sobs and shannoneven) metrics using mixed models with Gut_Section and Fish_Species as fixed effects and Fish_ID as a random effect.
#First, check to see that the sobs and shannoneven data are normal
hist(alpha.diversity.fish.2$sobs) #asses normality of sobs data
shapiro.test(alpha.diversity.fish.2$sobs) #sobs data appears to be normal
hist(alpha.diversity.fish.2$shannoneven) #asses normality of shannoneven data
shapiro.test(alpha.diversity.fish.2$shannoneven) #shannoneven data appears (barely) normal

#Model the sobs data in response to Gut_seciton, fish species, and fish ID
adiv.mod.gut.section.sobs=lmer(sobs~Gut_Section*Species+(1|Fish_Number),data=alpha.diversity.fish.2)
adiv.mod.gut.section.sobs
summary(adiv.mod.gut.section.sobs)
anova(adiv.mod.gut.section.sobs,ddf="Kenward-Roger") #Gut_Section is significant
summary(glht(adiv.mod.gut.section.sobs, linfct = mcp(Gut_Section = "Tukey")),test=adjusted("holm")) #HG and ST are not significantly different from each other, both are significantly different from GI.

#Model the shannoneven data in response to Gut_seciton, fish species, and fish ID
adiv.mod.gut.section.shannoneven=lmer(shannoneven~Gut_Section*Species+(1|Fish_Number),data=alpha.diversity.fish.2)
adiv.mod.gut.section.shannoneven
summary(adiv.mod.gut.section.shannoneven)
anova(adiv.mod.gut.section.shannoneven,ddf="Kenward-Roger") #Gut_Section is significant
summary(glht(adiv.mod.gut.section.shannoneven, linfct = mcp(Gut_Section = "Tukey")),test=adjusted("holm")) 
#Non of the gut sections are significantly different from each other.

#Now graph alpha diversity indices as a function of Gut_Section
sobs.gut.section.plot=ggplot(alpha.diversity.2.mean.gut_section,aes(x=Gut_Section,y=sobs,fill=Gut_Section))+
  ylim(0,675)+
  geom_bar(stat="identity")+
  scale_fill_manual(values=viridis(n=3))+
  geom_errorbar(aes(ymin=sobs-SE_sobs,ymax=sobs+SE_sobs),width=.5)+
  ggtitle("Observed Sequences")+
  theme_classic()+
  geom_text(x=1:3,y=c(650,275,550),label=c("A","B","A"))

#now repeat for shannoneven
shannoneven.gut.section.plot=ggplot(alpha.diversity.2.mean.gut_section,aes(x=Gut_Section,y=shannoneven,fill=Gut_Section))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=viridis(n=3))+
  geom_errorbar(aes(ymin=shannoneven-SE_shannoneven,ymax=shannoneven+SE_shannoneven),width=.5)+
  ggtitle("Shannon Eveness")+
  theme_classic()

plot_grid(sobs.gut.section.plot,shannoneven.gut.section.plot) #use the plot_grid function to plot the above 4 plots (par(mfrow=())) doesnt work with ggplot2. Export as PNG (800 x 455).
```

Sobs shows both ST and HG to have substantially higher alpha diversity compared to GI. Shannon eveness shows HG to have substantially higher alpha diversity than all other gut sections.

Given that there was no significant difference in any of the alpha diversity metrics between species, I will not plot them.

Next, plot the same alpha diversity metrics by Gut_SUBsection.

```{r}
#Calculate means and SE of the sobs and shannon evenness alpha diversity metrics for each Gut_Section and save as a df
alpha.diversity.2.mean.gut_subsection=aggregate(alpha.diversity.fish.F4.F8.2$sobs,by=list(alpha.diversity.fish.F4.F8.2$Gut_SubSection),FUN=mean)$x #aggregate (mean) sobs by Gut_SubSection, save in new df.
alpha.diversity.2.mean.gut_subsection=as.data.frame(alpha.diversity.2.mean.gut_subsection)
colnames(alpha.diversity.2.mean.gut_subsection)[1]="sobs" #rename column 1 to sobs.
alpha.diversity.2.mean.gut_subsection$SE_sobs=aggregate(alpha.diversity.fish.F4.F8.2$sobs,by=list(alpha.diversity.fish.F4.F8.2$Gut_SubSection),FUN=stderror)$x #aggregate (stderror) sobs by Gut_SubSection, save as a new column in df.
#repeat this for shannoneven
alpha.diversity.2.mean.gut_subsection$shannoneven=aggregate(alpha.diversity.fish.F4.F8.2$shannoneven,by=list(alpha.diversity.fish.F4.F8.2$Gut_SubSection),FUN=mean)$x
alpha.diversity.2.mean.gut_subsection$SE_shannoneven=aggregate(alpha.diversity.fish.F4.F8.2$shannoneven,by=list(alpha.diversity.fish.F4.F8.2$Gut_SubSection),FUN=stderror)$x
#now add in a Gut_SubSection column
alpha.diversity.2.mean.gut_subsection$Gut_SubSection=aggregate(alpha.diversity.fish.F4.F8.2$shannoneven,by=list(alpha.diversity.fish.F4.F8.2$Gut_SubSection),FUN=stderror)$Group.1

#Model the sobs data in response to Gut_SubSeciton, fish species, and fish ID
adiv.mod.gut.subsection.sobs=lmer(sobs~Gut_SubSection*Species+(1|Fish_Number),data=alpha.diversity.fish.F4.F8.2) #I get this warning when running the model: "fixed-effect model matrix is rank deficient so dropping 2 columns / coefficients"
adiv.mod.gut.subsection.sobs
summary(adiv.mod.gut.subsection.sobs)
anova(adiv.mod.gut.subsection.sobs,ddf="Kenward-Roger") #Gut_SubSection is significant. Some interaction terms for Species:Gut_SubSection are missing and the anova function tells me to interperet typeIII hypothesis with care. Potentially remove Species:Gut_SubSection interaction?
summary(glht(adiv.mod.gut.subsection.sobs, linfct = mcp(Gut_SubSection = "Tukey")),test=adjusted("holm")) #GI_2 and ST are significanty different from each other, everything else is not. Most pairwise comparisons have a pval of 1, so there might be something wrong with the model.

#Model the shannoneven data in response to Gut_seciton, fish species, and fish ID
adiv.mod.gut.section.shannoneven=lmer(shannoneven~Gut_Section*Species+(1|Fish_Number),data=alpha.diversity.fish.2)
adiv.mod.gut.section.shannoneven
summary(adiv.mod.gut.section.shannoneven)
anova(adiv.mod.gut.section.shannoneven,ddf="Kenward-Roger") #Gut_Section is significant
summary(glht(adiv.mod.gut.section.shannoneven, linfct = mcp(Gut_Section = "Tukey")),test=adjusted("holm")) 
#Non of the gut sections are significantly different from each other.


#Now graph sobs and shannoneven indices as a function of Gut_SubSection
sobs.gut.subsection.plot=ggplot(alpha.diversity.mean.Gut_SubSection,aes(x=Gut_SubSection,y=sobs,fill=Gut_SubSection))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=viridis(n=9))+
  geom_errorbar(aes(ymin=sobs-SE_sobs,ymax=sobs+SE_sobs),width=.5)+
  ggtitle("Observed Sequences")+
  theme_classic()+
  theme(legend.position = "none")
#now repeat for chao
chao.gut.subsection.plot=ggplot(alpha.diversity.mean.Gut_SubSection,aes(x=Gut_SubSection,y=chao,fill=Gut_SubSection))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=viridis(n=9))+
  geom_errorbar(aes(ymin=chao-SE_chao,ymax=chao+SE_chao),width=.5)+
  ggtitle("Chao")+
  theme_classic()
#now repeat for shannon
shannon.gut.subsection.plot=ggplot(alpha.diversity.mean.Gut_SubSection,aes(x=Gut_SubSection,y=shannon,fill=Gut_SubSection))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=viridis(n=9))+
  geom_errorbar(aes(ymin=shannon-SE_shannon,ymax=shannon+SE_shannon),width=.5)+
  ggtitle("Shannon")+
  theme_classic()
#now repeat for shannoneven
shannoneven.gut.subsection.plot=ggplot(alpha.diversity.mean.Gut_SubSection,aes(x=Gut_SubSection,y=shannoneven,fill=Gut_SubSection))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=viridis(n=9))+
  geom_errorbar(aes(ymin=shannoneven-SE_shannoneven,ymax=shannoneven+SE_shannoneven),width=.5)+
  ggtitle("Shannon Eveness")+
  theme_classic()+
  theme(legend.position = "none")

plot_grid(sobs.gut.subsection.plot,chao.gut.subsection.plot,shannon.gut.subsection.plot,shannoneven.gut.subsection.plot) #use the plot_grid function to plot the above 4 plots (par(mfrow=())) doesnt work with ggplot2. Save as PNG (1095 x 485).

plot_grid(sobs.gut.subsection.plot,shannoneven.gut.subsection.plot) #use this plot (only sobs and shannon even for CBOGS talk).

#NEED TO RUN STATS ON ALPHA DIVERIST DATA.

```

Next, look at how the gut microbiome dispersion changes through the gut.

```{r}
dispersion.gut.section=betadisper(weighted.unifrac.dist,type="centroid",group=metadata.fish.1$Gut_Section)
dispersion.gut.section
anova(dispersion.gut.section)
TukeyHSD(dispersion.gut.section,ordered=FALSE,conf.level=.95)
boxplot(dispersion.gut.section,col=colvec,xlab="Gut_Section")

dispersion.gut.subsection=betadisper(weighted.unifrac.F4.F8.dist,type="centroid",group=metadata.fish.F4.F8.1$Gut_SubSection)
dispersion.gut.subsection
anova(dispersion.gut.subsection)
TukeyHSD(dispersion.gut.subsection,ordered=FALSE,conf.level=.95)
boxplot(dispersion.gut.subsection,col=colvec2)
```

There is a significant difference in distances to centroid for the various gut sections. ST and HG samples have less dispersion relative to PC and GI samples. However, there are outliers in each of the HG subsections and substantial variation in dispersion between each of the GI subsections. There is no significant difference between the dispersions for the gut sections. This analysis likely does not warrant more work at this time.
